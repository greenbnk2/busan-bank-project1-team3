<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결재(승인) 관리 - 은행 펀드 상품 관리자</title>
    <link rel="stylesheet" th:href="@{/css/admin/admin_styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin/adminproduct.css}">
    <link rel="stylesheet" th:href="@{/css/admin/approval_styles.css}">
</head>
<body>
    <!-- 사이드바 Fragment -->
    <div th:replace="~{admin/_sidebar :: sidebar('approval')}"></div>

    <div class="main-content">
        <!-- 헤더 Fragment -->
        <div th:replace="~{admin/_header :: header}"></div>

    <div class="main-content-body">
        <div class="container">
            <header class="page-header">
                <h1>결재(승인) 관리</h1>
                <div class="header-actions">
                    <a th:href="@{/admin/approval/history}" class="btn btn-secondary">결재이력</a>
                </div>
            </header>
            
            <section class="section-block approval-filter">
                <h2 class="section-title">결재 요청 검색</h2>
                <div class="search-section">
                    <form th:action="@{/admin/approval}" method="get" style="margin: 0;">
                        <table class="search-table">
                            <tbody>
                                <tr>
                                    <td class="search-label">검색어</td>
                                    <td class="search-inputs">
                                        <input type="text" class="form-input search-input-large" id="filterKeyword" name="keyword" placeholder="결재 ID 또는 요청자를 입력하세요" th:value="${pageRequestDTO != null ? pageRequestDTO.keyword : ''}">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="search-label">결재상태</td>
                                    <td class="search-inputs">
                                        <select class="form-select search-select-medium" id="filterStatus" name="status">
                                            <option value="" th:selected="${pageRequestDTO == null || #strings.isEmpty(pageRequestDTO.status)}">전체</option>
                                            <option value="대기" th:selected="${pageRequestDTO != null && pageRequestDTO.status == '대기'}">대기</option>
                                            <option value="승인" th:selected="${pageRequestDTO != null && pageRequestDTO.status == '승인'}">승인</option>
                                            <option value="반려" th:selected="${pageRequestDTO != null && pageRequestDTO.status == '반려'}">반려</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="search-label">요청자</td>
                                    <td class="search-inputs">
                                        <input type="text" class="form-input search-input-large" id="filterRequester" name="requester" placeholder="요청자 이름을 입력하세요" th:value="${pageRequestDTO != null ? pageRequestDTO.requester : ''}">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="search-label">기간</td>
                                    <td class="search-inputs">
                                        <input type="date" class="form-input search-select-medium" id="filterDateFrom" name="dateFrom" th:value="${pageRequestDTO != null ? pageRequestDTO.dateFrom : ''}">
                                        <span style="margin: 0 10px;">~</span>
                                        <input type="date" class="form-input search-select-medium" id="filterDateTo" name="dateTo" th:value="${pageRequestDTO != null ? pageRequestDTO.dateTo : ''}">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="search-actions">
                            <button type="submit" class="btn btn-search">조회</button>
                            <button type="button" class="btn btn-secondary" th:onclick="|location.href='@{/admin/approval}'|">초기화</button>
                        </div>
                    </form>
                </div>
            </section>

            <section class="section-block">
                <h2 class="section-title">상품 결재 대기 목록</h2>
                <div class="history-table"
                     th:with="pageSize=${pageRequestDTO != null && pageRequestDTO.size > 0 ? pageRequestDTO.size : 10},
                              currentPage=${pageRequestDTO != null && pageRequestDTO.pg > 0 ? pageRequestDTO.pg : 1},
                              totalPages=${pageResponse != null && pageResponse.total > 0 ? T(java.lang.Math).floorDiv(pageResponse.total + pageSize - 1, pageSize) : 1}">
                    <div class="table-info">
                        <span>총 <strong th:text="${pageResponse != null ? pageResponse.total : 0}">0</strong>건</span>
                        <span class="pagination-info"
                              th:text="|${currentPage} / ${totalPages} page|">1 / 1 page</span>
                    </div>
                    <table class="fund-table" id="pendingTable">
                        <thead>
                        <tr>
                            <th>결재 ID</th>
                            <th>상품명</th>
                            <th>결재 유형</th>
                            <th>요청자</th>
                            <th>요청 일시</th>
                            <th>상태</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${pageResponse == null || #lists.isEmpty(pageResponse.dtoList)}">
                            <td colspan="6" class="empty-row">조회된 결재 요청이 없습니다.</td>
                        </tr>
                        <tr th:each="dto : ${pageResponse.dtoList}"
                            class="approval-row"
                            th:attr="data-id=${dto.apprNo},
                                     data-product=${dto.fundName},
                                     data-product-code=${dto.fundCode},
                                     data-type=${dto.apprType},
                                     data-requester=${dto.requester},
                                     data-requested=${dto.requestTime != null ? #temporals.format(dto.requestTime, 'yyyy-MM-dd HH:mm') : ''},
                                     data-status=${dto.status != null ? dto.status : '대기'},
                                     data-status-key=${dto.status == '승인' ? 'approved' : (dto.status == '반려' ? 'rejected' : 'pending')},
                                     data-reason=${dto.requestReason}">
                            <td class="table-ellipsis" th:text="${dto.apprNo}">APR-2024-021</td>
                            <td class="table-ellipsis" th:text="${dto.fundName}">BNK 스마트 적금</td>
                            <td class="table-ellipsis emphasis" th:text="${dto.apprType}">상품 신규 등록</td>
                            <td class="table-ellipsis" th:text="${dto.requester}">김운용</td>
                            <td class="table-ellipsis"
                                th:text="${dto.requestTime != null ? #temporals.format(dto.requestTime, 'yyyy-MM-dd HH:mm') : '-'}">2024-05-02 09:30</td>
                            <td class="table-ellipsis">
                                <span class="status-badge"
                                      th:text="${dto.status != null ? dto.status : '대기'}"
                                      th:classappend="${dto.status == '승인' ? ' status-approved' : (dto.status == '반려' ? ' status-rejected' : ' status-pending')}">대기</span>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <div class="pagination"
                         th:if="${pageResponse != null && pageResponse.total > 0}">
                        <button class="page-btn prev"
                                th:disabled="${!pageResponse.prev}"
                                th:attr="onclick=${pageResponse.prev} ? 'location.href=\'' + @{/admin/approval(pg=${pageResponse.start - 1}, size=${pageRequestDTO.size}, keyword=${pageRequestDTO.keyword}, status=${pageRequestDTO.status}, requester=${pageRequestDTO.requester}, dateFrom=${pageRequestDTO.dateFrom}, dateTo=${pageRequestDTO.dateTo})} + '\'' : null">&lt;</button>
                        <div class="page-numbers">
                            <button class="page-number"
                                    th:each="pageNum : ${#numbers.sequence(pageResponse.start, pageResponse.end)}"
                                    th:text="${pageNum}"
                                    th:classappend="${pageNum == (pageRequestDTO != null ? pageRequestDTO.pg : 1) ? ' active' : ''}"
                                    th:attr="onclick='location.href=\'' + @{/admin/approval(pg=${pageNum}, size=${pageRequestDTO.size}, keyword=${pageRequestDTO.keyword}, status=${pageRequestDTO.status}, requester=${pageRequestDTO.requester}, dateFrom=${pageRequestDTO.dateFrom}, dateTo=${pageRequestDTO.dateTo})} + '\''">
                                1
                            </button>
                        </div>
                        <button class="page-btn next"
                                th:disabled="${!pageResponse.next}"
                                th:attr="onclick=${pageResponse.next} ? 'location.href=\'' + @{/admin/approval(pg=${pageResponse.end + 1}, size=${pageRequestDTO.size}, keyword=${pageRequestDTO.keyword}, status=${pageRequestDTO.status}, requester=${pageRequestDTO.requester}, dateFrom=${pageRequestDTO.dateFrom}, dateTo=${pageRequestDTO.dateTo})} + '\'' : null">&gt;</button>
                    </div>
                </div>
            </section>


    <!-- 결재 상세 모달 -->
    <div id="approvalDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>결재 상세</h2>
                <span class="close" onclick="closeApprovalDetailModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="detail-panel">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">결재 ID</span>
                            <span class="detail-value" id="detailId">APR-2024-021</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">결재 유형</span>
                            <span class="detail-value" id="detailType">상품 신규 등록</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">상품명</span>
                            <span class="detail-value" id="detailProduct">BNK 스마트 적금</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">상품 코드</span>
                            <span class="detail-value" id="detailProductCode">BNK-001</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">요청자</span>
                            <span class="detail-value" id="detailRequester">김운용</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">요청 일시</span>
                            <span class="detail-value" id="detailRequestedAt">2024-05-02 09:30</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">상태</span>
                            <span class="detail-value" id="detailStatus"><span class="status-badge status-pending">대기</span></span>
                        </div>
                        <div class="detail-item span-2">
                            <span class="detail-label">요청 사유</span>
                            <span class="detail-desc" id="detailReason">신규 BNK 스마트 적금 상품 출시 결재 요청입니다.</span>
                        </div>
                    </div>
                    <form id="approvalForm" th:action="@{/admin/approval/approve}" method="post">
                        <input type="hidden" id="approvalApprNo" name="apprNo">
                        <input type="hidden" id="approvalFundCode" name="fundCode">
                        <input type="hidden" id="approvalRequestReason" name="requestReason">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <input type="hidden" id="approvalStatus" name="status" value="승인">
                        <div class="form-field">
                            <label for="approvalComment">결재 의견</label>
                            <textarea id="approvalComment" name="remarks" placeholder="승인 또는 반려 사유를 입력하세요."></textarea>
                        </div>
                        <div class="error-message" id="approvalError" aria-live="polite"></div>
                        <div class="detail-actions">
                            <button type="submit" class="btn btn-red" id="approveButton">승인</button>
                            <button type="button" class="btn btn-secondary" id="rejectButton">반려</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeApprovalDetailModal()">닫기</button>
            </div>
        </div>
    </div>
            <!-- 푸터 영역 -->
            <footer class="admin-footer"></footer>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rows = Array.from(document.querySelectorAll('.approval-row'));
        const detailId = document.getElementById('detailId');
        const detailType = document.getElementById('detailType');
        const detailRequester = document.getElementById('detailRequester');
        const detailRequestedAt = document.getElementById('detailRequestedAt');
        const detailStatus = document.getElementById('detailStatus');
        const detailReason = document.getElementById('detailReason');
        const detailProduct = document.getElementById('detailProduct');
        const detailProductCode = document.getElementById('detailProductCode');
        const commentField = document.getElementById('approvalComment');
        const errorBox = document.getElementById('approvalError');
        const approvalForm = document.getElementById('approvalForm');
        const approvalApprNoInput = document.getElementById('approvalApprNo');
        const approvalFundCodeInput = document.getElementById('approvalFundCode');
        const approvalRequestReasonInput = document.getElementById('approvalRequestReason');
        const approvalStatusInput = document.getElementById('approvalStatus');
        const approveButton = document.getElementById('approveButton');
        const rejectButton = document.getElementById('rejectButton');
        const overviewMap = {
            total: document.querySelector('[data-metric="total"]'),
            pending: document.querySelector('[data-metric="pending"]'),
            approved: document.querySelector('[data-metric="approved"]'),
            rejected: document.querySelector('[data-metric="rejected"]')
        };

        function setDetail(row) {
            rows.forEach((r) => r.classList.remove('selected'));
            row.classList.add('selected');

            detailId.textContent = row.dataset.id;
            detailType.textContent = row.dataset.type || '';
            detailRequester.textContent = row.dataset.requester;
            detailRequestedAt.textContent = row.dataset.requested;

            const statusKey = row.dataset.statusKey || 'pending';
            const statusLabel = row.dataset.status || row.dataset.statusKey;
            detailStatus.innerHTML = `<span class="status-badge status-${statusKey}">${statusLabel}</span>`;

            detailReason.textContent = row.dataset.reason || '';
            detailProduct.textContent = row.dataset.product || '-';
            detailProductCode.textContent = row.dataset.productCode || '-';
            if (approvalApprNoInput) {
                approvalApprNoInput.value = row.dataset.id || '';
            }
            if (approvalFundCodeInput) {
                approvalFundCodeInput.value = row.dataset.productCode || '';
            }
            if (approvalRequestReasonInput) {
                approvalRequestReasonInput.value = row.dataset.reason || '';
            }
            if (approvalStatusInput) {
                approvalStatusInput.value = '승인';
            }

            commentField.value = '';
            errorBox.textContent = '';
            
            // 모달 표시
            document.getElementById('approvalDetailModal').classList.add('active');
        }

        function closeApprovalDetailModal() {
            document.getElementById('approvalDetailModal').classList.remove('active');
        }
        
        // 전역 스코프에서 접근 가능하도록 설정
        window.closeApprovalDetailModal = closeApprovalDetailModal;

        function updateOverviewCounts() {
            const counts = { total: 0, pending: 0, approved: 0, rejected: 0 };

            document.querySelectorAll('#pendingTable tbody tr').forEach((row) => {
                const key = row.dataset.statusKey || 'pending';
                counts.total += 1;
                if (counts[key] !== undefined) counts[key] += 1;
            });

            Object.entries(overviewMap).forEach(([key, el]) => {
                if (el) {
                    el.textContent = `${counts[key]}건`;
                }
            });
        }

        rows.forEach((row) => {
            row.addEventListener('click', () => setDetail(row));
        });

        if (approveButton) {
            approveButton.addEventListener('click', () => {
                if (approvalStatusInput) {
                    approvalStatusInput.value = '승인';
                }
                errorBox.textContent = '';
            });
        }

        rejectButton.addEventListener('click', () => {
            if (!commentField.value.trim()) {
                errorBox.textContent = '반려 사유를 입력해주세요.';
                commentField.focus();
                return;
            }
            if (approvalStatusInput) {
                approvalStatusInput.value = '반려';
            }
            errorBox.textContent = '';
            approvalForm.submit();
        });

        commentField.addEventListener('input', () => {
            if (commentField.value.trim()) {
                errorBox.textContent = '';
            }
        });

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('approvalDetailModal');
            if (event.target === modal) {
                closeApprovalDetailModal();
            }
        }

        updateOverviewCounts();
    });
</script>
    <!-- 사이드바 스크립트 -->
    <div th:replace="~{admin/_sidebar :: sidebar-script}"></div>
</body>
</html>


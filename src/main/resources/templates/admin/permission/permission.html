<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>권한 관리 - 은행 펀드 상품 관리자</title>
    <link rel="stylesheet" th:href="@{/css/admin/admin_styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin/permission.css}">
</head>
<body>
    <!-- 사이드바 Fragment -->
    <div th:replace="~{admin/_sidebar :: sidebar('permission')}"></div>

    <div class="main-content">
        <!-- 헤더 Fragment -->
        <div th:replace="~{admin/_header :: header}"></div>
        <div class="main-content-body">
            <div class="container">
                <!-- 페이지 헤더 -->
                <header class="page-header">
                    <h1>권한 관리</h1>
                </header>
                <h2 class="section-title">관리자 목록</h2>

                <!-- 안내 메시지 -->
                <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
                    <p style="margin: 0; color: #666; font-size: 15px;">
                        추가할 관리자 계정을 검색하시기 바랍니다.
                    </p>
                </div>

                <!-- 검색 섹션 -->
                <div class="search-section">
                    <form th:action="@{/admin/permission}" method="get" style="margin: 0;">
                        <table class="search-table">
                            <tbody>
                            <tr>
                                <td class="search-label">검색조건</td>
                                <td class="search-inputs">
                                    <select class="form-select search-select-small"
                                            id="permissionSearchSelect"
                                            name="searchType">
                                        <option value="custId"
                                                th:selected="${pageRequestDTO != null and pageRequestDTO.searchType == 'custId'}">
                                            아이디
                                        </option>
                                        <option value="custName"
                                                th:selected="${pageRequestDTO != null and pageRequestDTO.searchType == 'custName'}">
                                            이름
                                        </option>
                                    </select>

                                    <input type="text"
                                           class="form-input search-input-large"
                                           id="permissionSearchInput"
                                           name="keyword"
                                           placeholder="추가할 관리자 계정을 검색하시기 바랍니다."
                                           th:value="${pageRequestDTO != null ? pageRequestDTO.keyword : ''}">
                                </td>
                            </tr>

                            </tbody>
                        </table>
                        <div class="search-actions">
                            <button class="btn btn-search" type="submit">조회</button>
                            <button class="btn btn-secondary" type="button" th:onclick="|location.href='@{/admin/permission}'|">초기화</button>
                        </div>
                    </form>
                </div>

                <!-- 검색 결과 목록 -->
                <div class="table-section" th:if="${pageRequestDTO != null and pageRequestDTO.keyword != null and pageRequestDTO.keyword != ''}">
                    <div class="table-info">
                        <span>
                            총
                            <strong th:text="${pageResponse != null ? pageResponse.total : 0}">0</strong>개
                        </span>
                    </div>
                    <table class="permission-table">
                        <thead>
                            <tr>
                                <th>번호</th>
                                <th>아이디</th>
                                <th>이름</th>
                                <th>전화번호</th>
                                <th>이메일</th>
                                <th>가입일</th>
                                <th>권한</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
                        <!-- 데이터 없을 때 -->
                        <tr th:if="${pageResponse == null or #lists.isEmpty(pageResponse.dtoList)}">
                            <td colspan="8" style="text-align: center; padding: 40px; display: table-cell; width: 100%;">검색 결과가 없습니다.</td>
                        </tr>
                        <!-- 데이터 있을 때 -->
                        <tr th:each="user, stat : ${pageResponse != null ? pageResponse.dtoList : {}}">
                            <!-- 역순 번호 : startNo - index -->
                            <td th:text="${pageResponse.startNo - stat.index}">1</td>
                            <td th:text="${user.custId}">admin01</td>
                            <td th:text="${user.custName}">홍길동</td>
                            <td th:text="${user.custHp}">010-1234-5678</td>
                            <td th:text="${user.custEmail}">admin01@example.com</td>
                            <td th:text="${#temporals.format(user.joinDate, 'yyyy-MM-dd')}">2024-01-15</td>
                            <td>
                                <select class="form-select permission-select"
                                        th:attr="data-cust-no=${user.custNo}">
                                    <option value="SAD">최고관리자</option>
                                    <option value="ADM" selected>일반 관리자</option>
                                    <option value="CS">상담원</option>
                                </select>
                            </td>
                            <td>
                                <button type="button"
                                        class="btn btn-secondary btn-small"
                                        th:onclick="|addAdmin(${user.custNo})|">
                                    추가
                                </button>
                            </td>

                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 권한 관리 목록 -->
                <div class="table-section">
                    <h2 class="section-title">관리자 목록</h2>
                    <!-- 안내 메시지 -->
                    <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
                        <p style="margin: 0; color: #666; font-size: 15px;">
                            관리자 계정을 조회하고 관리할 수 있습니다.
                        </p>
                    </div>


                    <!-- 관리자 목록 검색 섹션 -->
                    <div class="search-section">
                        <!-- 같은 /admin/permission 으로 GET -->
                        <form th:action="@{/admin/permission}" method="get" style="margin: 0;">
                            <table class="search-table">
                                <tbody>
                                <tr>
                                    <td class="search-label">검색조건</td>
                                    <td class="search-inputs">
                                        <!-- 아래 검색도 pageRequestDTO.searchType / keyword 공유 -->
                                        <select class="form-select search-select-small" name="searchType">
                                            <option value="adminId"
                                                    th:selected="${pageRequestDTO != null and pageRequestDTO.searchType == 'adminId'}">
                                                아이디
                                            </option>
                                            <option value="adminName"
                                                    th:selected="${pageRequestDTO != null and pageRequestDTO.searchType == 'adminName'}">
                                                이름
                                            </option>
                                        </select>
                                        <input type="text"
                                               class="form-input search-input-large"
                                               name="keyword"
                                               placeholder="관리자를 검색하세요"
                                               th:value="${pageRequestDTO != null ? pageRequestDTO.keyword : ''}">
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <div class="search-actions">
                                <button class="btn btn-search" type="submit">조회</button>
                                <button class="btn btn-secondary" type="button" onclick="resetAdminSearch()">초기화</button>
                            </div>
                        </form>
                    </div>

                    <div class="table-info">
                        <span>
                            총
                            <strong th:text="${adminPage != null ? adminPage.total : 0}">0</strong>개
                        </span>
                        <span class="pagination-info"
                              th:if="${adminPage != null and adminPage.total > 0}">
                            <span th:text="${adminPage.pg}">1</span>
                            /
                            <span th:text="${(adminPage.total + adminPage.size - 1) / adminPage.size}">1</span>
                            page
                        </span>
                    </div>

                    <table class="permission-table">
                        <thead>
                        <tr>
                            <th>번호</th>
                            <th>아이디</th>
                            <th>이름</th>
                            <th>전화번호</th>
                            <th>이메일</th>
                            <th>가입일</th>
                            <th>권한</th>
                            <th>관리</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- 관리자 없음 -->
                        <tr th:if="${adminPage == null or #lists.isEmpty(adminPage.dtoList)}">
                            <td colspan="8" style="text-align: center; padding: 40px; display: table-cell; width: 100%;">등록된 관리자가 없습니다.</td>
                        </tr>

                        <!-- 관리자 목록 -->
                        <tr th:each="admin, stat : ${adminPage != null ? adminPage.dtoList : {}}">
                            <!-- 역순 번호 -->
                            <td th:text="${adminPage.startNo - stat.index}">1</td>

                            <td th:text="${admin.adminId}">admin01</td>
                            <td th:text="${admin.adminName}">홍길동</td>

                            <!-- AdminListDTO 필드명에 맞춰서 작성 (custHp / custEmail / joinDate 라고 가정) -->
                            <td th:text="${admin.custHp}">010-1234-5678</td>
                            <td th:text="${admin.custEmail}">admin01@example.com</td>
                            <td th:text="${#temporals.format(admin.joinDate, 'yyyy-MM-dd')}">2024-01-15</td>
                            <!-- joinDate가 String이면 위 대신 그냥 admin.joinDate 쓰면 됨 -->

                            <td>
                                <select class="form-select permission-select"
                                        th:data-admin-no="${admin.adminNo}"
                                        onchange="onChangeRole(this)">
                                    <option value="SAD" th:selected="${admin.role == 'SAD'}">최고관리자</option>
                                    <option value="ADM" th:selected="${admin.role == 'ADM'}">일반 관리자</option>
                                    <option value="CS"  th:selected="${admin.role == 'CS'}">상담원</option>
                                </select>
                            </td>
                            <td>
                                <button class="btn btn-secondary btn-small"
                                        th:onclick="|updateAdminRole(${admin.adminNo})|">
                                    수정
                                </button>
                                <button class="btn btn-secondary btn-small"
                                        th:onclick="|deleteAdmin(${admin.adminNo})|">
                                    삭제
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <!-- 페이징 -->
                    <div class="pagination"
                         th:if="${adminPage != null and adminPage.total > 0}">
                        <!-- 이전 -->
                        <button class="page-btn prev"
                                th:if="${adminPage.prev}"
                                th:onclick="|location.href='@{/admin/permission(pg=${adminPage.start - 1}, searchType=${pageRequestDTO != null and pageRequestDTO.searchType != null ? pageRequestDTO.searchType : ''}, keyword=${pageRequestDTO != null and pageRequestDTO.keyword != null ? pageRequestDTO.keyword : ''})}'|">
                            &lt;
                        </button>

                        <!-- 페이지 번호 -->
                        <div class="page-numbers">
                            <button class="page-number"
                                    th:each="p : ${#numbers.sequence(adminPage.start, adminPage.end)}"
                                    th:text="${p}"
                                    th:classappend="${p == adminPage.pg} ? ' active'"
                                    th:onclick="|location.href='@{/admin/permission(pg=${p}, searchType=${pageRequestDTO != null and pageRequestDTO.searchType != null ? pageRequestDTO.searchType : ''}, keyword=${pageRequestDTO != null and pageRequestDTO.keyword != null ? pageRequestDTO.keyword : ''})}'|">
                                1
                            </button>
                        </div>

                        <!-- 다음 -->
                        <button class="page-btn next"
                                th:if="${adminPage.next}"
                                th:onclick="|location.href='@{/admin/permission(pg=${adminPage.end + 1}, searchType=${pageRequestDTO != null and pageRequestDTO.searchType != null ? pageRequestDTO.searchType : ''}, keyword=${pageRequestDTO != null and pageRequestDTO.keyword != null ? pageRequestDTO.keyword : ''})}'|">
                            &gt;
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <form id="addAdminForm"
          th:action="@{/admin/permission/add}"
          method="post"
          style="display:none;">

        <!-- 추가할 회원 번호 -->
        <input type="hidden" name="custNo" id="addAdminCustNo">


        <!-- 선택한 권한 -->
        <input type="hidden" name="role" id="addAdminRole">

        <!-- 검색 조건 유지용 (선택) -->
        <input type="hidden" name="searchType"
               th:value="${pageRequestDTO != null ? pageRequestDTO.searchType : ''}">
        <input type="hidden" name="keyword"
               th:value="${pageRequestDTO != null ? pageRequestDTO.keyword : ''}">
        <input type="hidden" name="pg"
               th:value="${pageRequestDTO != null ? pageRequestDTO.pg : 1}">
        <input type="hidden" name="size"
               th:value="${pageRequestDTO != null ? pageRequestDTO.size : 10}">

        <!-- CSRF -->
        <input type="hidden"
               th:name="${_csrf.parameterName}"
               th:value="${_csrf.token}">
    </form>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const updateRoleUrl = /*[[@{/admin/permission/role}]]*/ '/admin/permission/role';
        // Spring Security 에서 제공하는 CSRF 정보
        const csrfHeaderName = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';
        const csrfToken      = /*[[${_csrf.token}]]*/ '';

        console.log('csrfHeaderName =', csrfHeaderName);
        console.log('csrfToken =', csrfToken);
        // 검색 결과에서 "관리자 추가" 버튼
        function addAdmin(custNo) {
            if (confirm('이 계정을 관리자로 추가하시겠습니까?')) {
                // TODO: 실제 추가 처리 (POST 요청)
            }
        }

        // 관리자 목록 검색 초기화
        function resetAdminSearch() {
            const input = document.querySelector('input[name="adminKeyword"]');
            if (input) {
                input.value = '';
            }
            // 단순히 페이지 리로드
            location.href = /*[[@{/admin/permission}]]*/ '/admin/permission';
        }

        // 셀렉트 박스에서 권한 선택 변경 시(미리보기 용)
        function onChangeRole(selectEl) {
            const adminNo = selectEl.getAttribute('data-admin-no');
            const role = selectEl.value;
            console.log('선택된 권한 미리보기 => ADMIN_NO:', adminNo, 'ROLE:', role);
        }

        // 검색 결과 목록에서 권한 선택 변경 시
        function onChangeSearchResultRole(selectEl) {
            const custNo = selectEl.getAttribute('data-cust-no');
            const role = selectEl.value;
            console.log('검색 결과 권한 선택 => CUST_NO:', custNo, 'ROLE:', role);
        }

        // "수정" 버튼 클릭 시 - 실제 권한 변경 요청
        function updateAdminRole(adminNo) {
            const selectEl = document.querySelector(
                '.permission-select[data-admin-no="' + adminNo + '"]'
            );

            if (!selectEl) {
                alert('권한 정보를 찾을 수 없습니다.');
                return;
            }

            const role = selectEl.value;

            if (!confirm('이 관리자의 권한을 "' + role + '"(으)로 변경하시겠습니까?')) {
                return;
            }

            fetch(updateRoleUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                    [csrfHeaderName]: csrfToken
                },
                body: new URLSearchParams({
                    adminNo: adminNo,
                    role: role,
                    _csrf: csrfToken   // 파라미터로도 같이 보냄(혹시 몰라서)
                }),
                credentials: 'same-origin'  // 세션 쿠키 같이 전송
            })
                .then(res => {
                    console.log('응답 상태:', res.status);
                    if (!res.ok) {
                        throw new Error('HTTP ' + res.status);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('응답 데이터:', data);
                    if (data.success) {
                        alert('권한이 변경되었습니다.');
                    } else {
                        alert('권한 변경에 실패했습니다.');
                    }
                })
                .catch(err => {
                    console.error('권한 변경 에러:', err);
                    alert('권한 변경 중 오류가 발생했습니다.');
                });
        }


        // "삭제" 버튼 클릭 시
        function deleteAdmin(adminNo) {
            if (confirm('정말 이 관리자를 삭제하시겠습니까?')) {
                // TODO: 실제 삭제 요청 (POST/DELETE)
            }
        }



        // 검색 결과에서 "관리자 추가" 버튼
        function addAdmin(custNo) {
            // 해당 custNo 의 권한 select 찾기
            const selectEl = document.querySelector('.permission-select[data-cust-no="' + custNo + '"]');
            if (!selectEl) {
                alert('권한 선택 정보를 찾을 수 없습니다.');
                return;
            }

            const role = selectEl.value;
            if (!role) {
                alert('권한을 선택해 주세요.');
                return;
            }

            if (!confirm('이 계정을 선택한 권한으로 관리자로 추가하시겠습니까?\n\n권한: ' + role)) {
                return;
            }

            const form = document.getElementById('addAdminForm');
            document.getElementById('addAdminCustNo').value = custNo;
            document.getElementById('addAdminRole').value = role;

            form.submit();
        }


        /*]]>*/
    </script>
    <!-- 사이드바 스크립트 -->
    <div th:replace="~{admin/_sidebar :: sidebar-script}"></div>
</body>
</html>


<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>펀드 수정 - 은행 펀드 상품 관리자</title>
    <link rel="stylesheet" th:href="@{/css/admin/admin_styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin/adminproduct.css}">
</head>
<body>
    <!-- 사이드바 Fragment -->
    <div th:replace="~{admin/_sidebar :: sidebar('product-edit')}"></div>

    <div class="main-content">
        <!-- 헤더 Fragment -->
        <div th:replace="~{admin/_header :: header}"></div>
        <div class="main-content-body">
            <div class="container">
                <!-- 페이지 헤더 -->
                <header class="page-header">
                    <h1>펀드 수정</h1>
                </header>

                <!-- 펀드 수정 폼 -->
                <form th:action="@{/admin/product/edit}" method="post" enctype="multipart/form-data">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" id="fundCode" th:value="${fund != null ? fund.fundCode : ''}"/>
                    <input type="hidden" id="sessionId" th:value="${sessionId != null ? sessionId : ''}"/>

                <!-- 필수정보 -->
                <div class="form-section">
                    <h2 class="section-title">필수정보</h2>
                    <div class="form-table">
                        <!-- 상품명  -->
                        <div class="form-row">
                            <div class="form-label">상품명</div>
                            <div class="form-input-wrapper">
                                <input type="text" 
                                       class="form-input" 
                                       id="productName"
                                       name="fundName"
                                       placeholder="상품명을 입력하세요"
                                       th:value="${fund != null} ? ${fund.fundName} : ''"
                                       readonly>
                            </div>
                        </div>
                        <!-- 상품코드 -->
                        <div class="form-row">
                            <div class="form-label">상품코드</div>
                            <div class="form-input-wrapper">
                                <input type="text" 
                                       class="form-input" 
                                       id="productCode"
                                       name="fundCode"
                                       placeholder="상품코드를 입력하세요"
                                       th:value="${fund != null} ? ${fund.fundCode} : ''"
                                       readonly>
                            </div>
                        </div>
                        <!-- 펀드유형  -->
                        <div class="form-row">
                            <div class="form-label">펀드유형</div>
                            <div class="form-input-wrapper">
                                <select class="form-select"
                                        name="fundType"
                                        required>
                                    <option value="">펀드유형 선택</option>
                                    <option th:each="cat : ${categoryList}"
                                            th:value="${cat.categoryCode}"
                                            th:text="${cat.categoryName}"
                                            th:selected="${fund != null and fund.fundType == cat.categoryCode}">
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-label">투자등급</div>
                            <div class="form-input-wrapper">
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="investGrade" value="매우 낮은 위험"
                                               th:checked="${fund != null and fund.investGrade == '매우 낮은 위험'}"> 매우 낮은 위험
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="investGrade" value="낮은 위험"
                                               th:checked="${fund != null and fund.investGrade == '낮은 위험'}"> 낮은 위험
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="investGrade" value="중간 위험"
                                               th:checked="${fund != null and fund.investGrade == '중간 위험'}"> 중간 위험
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="investGrade" value="다소 높은 위험"
                                               th:checked="${fund != null and fund.investGrade == '다소 높은 위험'}"> 다소 높은 위험
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="investGrade" value="높은 위험"
                                               th:checked="${fund != null and fund.investGrade == '높은 위험'}"> 높은 위험
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="investGrade" value="매우 높은 위험"
                                               th:checked="${fund != null and fund.investGrade == '매우 높은 위험'}"> 매우 높은 위험
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 가입경로  -->
                        <div class="form-row">
                            <div class="form-label">가입경로</div>
                            <div class="form-input-wrapper">
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="subscriptionMethod" value="인터넷, 스마트폰"
                                               th:checked="${fund != null and (fund.subscriptionMethod == '인터넷, 스마트폰' or fund.subscriptionMethod == '인터넷, 스마트폰')}"
                                               required> 인터넷, 스마트폰
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="subscriptionMethod" value="오프라인"
                                               th:checked="${fund != null and fund.subscriptionMethod == '오프라인'}"
                                               required> 오프라인
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-label">운용사</div>
                            <div class="form-input-wrapper">
                                <input type="text"
                                       class="form-input"
                                       id="managementCompany"
                                       placeholder="운용사를 입력하세요"
                                       th:value="${fund != null} ? ${fund.assetManagerName} : ''"
                                       readonly>
                            </div>
                        </div>

                        <!-- 상품특징  -->
                        <div class="form-row">
                            <div class="form-label">상품특징</div>
                            <div class="form-input-wrapper">
                                <textarea class="form-textarea"
                                          id="productFeatures"
                                          name="fundFeature"
                                          rows="5"
                                          placeholder="상품특징을 입력하세요"
                                          th:text="${fund != null} ? ${fund.fundFeature} : ''"></textarea>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- 유의사항 -->
                <div class="form-section">
                    <h2 class="section-title">유의사항</h2>
                    <div class="form-table">
                        <div class="form-row">
                            <div class="form-label">상품별 주요 투자 위험</div>
                            <div class="form-input-wrapper">
                                <textarea class="form-textarea" 
                                          id="precautions1" 
                                          name="notice1"
                                          rows="5" 
                                          placeholder="유의사항을 입력하세요"
                                          th:text="${fund != null} ? ${fund.notice1} : ''"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-label">이익 및 손실 발행 구조</div>
                            <div class="form-input-wrapper">
                                <textarea class="form-textarea" 
                                          id="precautions2" 
                                          name="notice2"
                                          rows="5" 
                                          placeholder="유의사항을 입력하세요"
                                          th:text="${fund != null} ? ${fund.notice2} : ''"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 문서관리 -->
                <div class="form-section">
                    <h2 class="section-title">문서관리</h2>
                    <div class="form-table">
                        <div class="form-row">
                            <div class="form-label">약관</div>
                            <div class="form-input-wrapper">
                                <!-- 기존 파일 목록 -->
                                <div class="existing-files" th:if="${termsDoc != null}">
                                    <div class="file-item">
                                        <span class="file-item-name" th:text="${termsDoc.docFileName}">약관.pdf</span>
                                        <div class="file-actions">
                                            <a class="file-download" title="다운로드"
                                               th:href="@{${termsDoc.docUrl}}"
                                               target="_blank">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="download-icon">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                                </svg>
                                            </a>
                                            <button type="button" class="file-item-remove" onclick="deleteExistingFile(this, 'terms')" title="삭제">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="delete-icon">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- 새 파일 업로드 -->
                                <div class="file-upload">
                                    <input type="file" id="termsDoc" name="termsDoc"
                                           accept=".pdf,.doc,.docx" style="display: none;">
                                    <button type="button" class="btn btn-secondary"
                                            onclick="document.getElementById('termsDoc').click()">
                                        새 파일 선택
                                    </button>
                                    <div id="termsDocList" class="file-list"></div>
                                    <small class="file-help">
                                        새 파일을 선택하면 기존 약관 문서가 대체됩니다. (PDF, DOC, DOCX)
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-label">투자설명서</div>
                            <div class="form-input-wrapper">
                                <!-- 기존 파일 목록 -->
                                <div class="existing-files" th:if="${investDoc != null}">
                                    <div class="file-item">
                                        <span class="file-item-name" th:text="${investDoc.docFileName}">투자설명서.pdf</span>
                                        <div class="file-actions">
                                            <a class="file-download" title="다운로드"
                                               th:href="@{${investDoc.docUrl}}"
                                               target="_blank">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="download-icon">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                                </svg>
                                            </a>
                                            <button type="button" class="file-item-remove" onclick="deleteExistingFile(this, 'investment')" title="삭제">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="delete-icon">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- 새 파일 업로드 -->
                                <div class="file-upload">
                                    <input type="file" id="investmentDoc" name="investmentDoc"
                                           accept=".pdf,.doc,.docx" style="display: none;">
                                    <button type="button" class="btn btn-secondary"
                                            onclick="document.getElementById('investmentDoc').click()">
                                        새 파일 선택
                                    </button>
                                    <div id="investmentDocList" class="file-list"></div>
                                    <small class="file-help">
                                        새 파일을 선택하면 기존 투자설명서 문서가 대체됩니다.
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-label">간이 투자 설명서</div>
                            <div class="form-input-wrapper">
                                <!-- 기존 파일 목록 -->
                                <div class="existing-files" th:if="${summaryDoc != null}">
                                    <div class="file-item">
                                        <span class="file-item-name" th:text="${summaryDoc.docFileName}">간이투자설명서.pdf</span>
                                        <div class="file-actions">
                                            <a class="file-download" title="다운로드"
                                               th:href="@{${summaryDoc.docUrl}}"
                                               target="_blank">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="download-icon">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                                </svg>
                                            </a>
                                            <button type="button" class="file-item-remove" onclick="deleteExistingFile(this, 'simple')" title="삭제">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="delete-icon">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- 새 파일 업로드 -->
                                <div class="file-upload">
                                    <input type="file" id="simpleInvestmentDoc" name="simpleInvestmentDoc"
                                           accept=".pdf,.doc,.docx" style="display: none;">
                                    <button type="button" class="btn btn-secondary"
                                            onclick="document.getElementById('simpleInvestmentDoc').click()">
                                        새 파일 선택
                                    </button>
                                    <div id="simpleInvestmentDocList" class="file-list"></div>
                                    <small class="file-help">
                                        새 파일을 선택하면 기존 간이투자설명서 문서가 대체됩니다.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 폼 액션 버튼 -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-red" th:disabled="${lockError == true}">수정</button>
                    <a th:href="@{/admin/product/pending}" class="btn btn-secondary">취소</a>
                </div>
                </form>
                <!-- 푸터 영역 -->
                <footer class="admin-footer"></footer>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/

/*        var editUrl = /!*[[@{/admin/product/edit}]]*!/ '';
        function editProduct(productId) {
            location.href = editUrl + '?id=' + productId;
        }*/

        // 약관 파일 업로드
        const termsInput = document.getElementById('termsDoc');
        if (termsInput) {
            termsInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    addFileToList('termsDocList', file);
                }
            });
        }

        // 투자설명서 파일 업로드
        const investInput = document.getElementById('investmentDoc');
        if (investInput) {
            investInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    addFileToList('investmentDocList', file);
                }
            });
        }

        // 간이 투자 설명서 파일 업로드
        const summaryInput = document.getElementById('simpleInvestmentDoc');
        if (summaryInput) {
            summaryInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    addFileToList('simpleInvestmentDocList', file);
                }
            });
        }

        // 파일 목록에 추가
        function addFileToList(listId, file, inputId) {
            const fileList = document.getElementById(listId);
            if (!fileList) return;

            fileList.innerHTML = '';
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span class="file-item-name">${file.name}</span>
                <div class="file-actions">
                    <a href="#" class="file-download" title="다운로드">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="download-icon">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                    </a>
                    <button type="button" class="file-item-remove" onclick="removeFile(this, '${listId}', '${inputId}')" title="삭제">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="delete-icon">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            `;
            fileList.appendChild(fileItem);
        }

        // 파일 삭제
        function removeFile(button, listId, inputId) {
            const fileList = document.getElementById(listId);
            fileList.innerHTML = '';
            
            // 파일 input 초기화
            document.getElementById(inputId).value = '';
            
            // 파일 선택 버튼 다시 표시
            if (inputId === 'termsDoc') {
                document.getElementById('termsDocUpload').style.display = 'flex';
            } else if (inputId === 'investmentDoc') {
                document.getElementById('investmentDocUpload').style.display = 'flex';
            } else if (inputId === 'simpleInvestmentDoc') {
                document.getElementById('simpleInvestmentDocUpload').style.display = 'flex';
            }
        }

        // 펀드 검색 함수
        function searchFunds() {
            const searchTerm = document.getElementById('searchFund').value;
            // 검색 로직 구현
            console.log('검색어:', searchTerm);
        }


        // 운용재개 함수
        function resumeProduct() {
            if (confirm('운용을 재개하시겠습니까?')) {
                // TODO: 운용재개 API 호출
                alert('운용이 재개되었습니다.');
                // 상태에 따라 버튼 토글
                document.getElementById('resumeBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'inline-block';
            }
        }

        // 운용중단 함수
        function endProduct() {
            if (confirm('운용을 중단하시겠습니까?')) {
                // TODO: 운용중단 API 호출
                alert('운용이 중단되었습니다.');
                // 상태에 따라 버튼 토글
                document.getElementById('stopBtn').style.display = 'none';
                document.getElementById('resumeBtn').style.display = 'inline-block';
            }
        }

        // 반영예약 함수
        function reserveProduct() {
            if (confirm('변경사항을 반영예약하시겠습니까?')) {
                // TODO: 반영예약 API 호출
                alert('반영예약이 완료되었습니다.');
            }
        }

        // 기존 파일 삭제
        function deleteExistingFile(button, fileType) {
            if (confirm('기존 파일을 삭제하시겠습니까?')) {
                const fileItem = button.closest('.file-item');
                const existingFiles = fileItem.closest('.existing-files');
                fileItem.remove();
                
                // 기존 파일이 없으면 영역 숨기기 및 파일 선택 버튼 표시
                if (existingFiles && existingFiles.querySelectorAll('.file-item').length === 0) {
                    existingFiles.style.display = 'none';
                    // 파일 선택 버튼 다시 표시
                    if (fileType === 'terms') {
                        document.getElementById('termsDocUpload').style.display = 'flex';
                    } else if (fileType === 'investment') {
                        document.getElementById('investmentDocUpload').style.display = 'flex';
                    } else if (fileType === 'simple') {
                        document.getElementById('simpleInvestmentDocUpload').style.display = 'flex';
                    }
                }
            }
        }

        // 페이지 로드 시 기존 파일이 있으면 파일 선택 버튼 숨기기
        document.addEventListener('DOMContentLoaded', function() {
            // 약관
            const termsExistingFiles = document.querySelector('#termsDocUpload')?.previousElementSibling;
            if (termsExistingFiles && termsExistingFiles.classList.contains('existing-files') && 
                termsExistingFiles.querySelectorAll('.file-item').length > 0) {
                document.getElementById('termsDocUpload').style.display = 'none';
            }
            
            // 투자설명서
            const investmentExistingFiles = document.querySelector('#investmentDocUpload')?.previousElementSibling;
            if (investmentExistingFiles && investmentExistingFiles.classList.contains('existing-files') && 
                investmentExistingFiles.querySelectorAll('.file-item').length > 0) {
                document.getElementById('investmentDocUpload').style.display = 'none';
            }
            
            // 간이 투자 설명서
            const simpleExistingFiles = document.querySelector('#simpleInvestmentDocUpload')?.previousElementSibling;
            if (simpleExistingFiles && simpleExistingFiles.classList.contains('existing-files') && 
                simpleExistingFiles.querySelectorAll('.file-item').length > 0) {
                document.getElementById('simpleInvestmentDocUpload').style.display = 'none';
            }

            // 잠금 관리 초기화 (잠금 오류가 아닐 때만)
            const lockError = /*[[${lockError}]]*/ false;
            if (!lockError) {
                initEditLock();
            }
            
            // 잠금 상태일 때 폼 제출 방지
            if (lockError) {
                const form = document.querySelector('form');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        alert('다른 사용자가 수정 중입니다. 수정이 완료될 때까지 기다려주세요.');
                        return false;
                    });
                }
            }
        });

        // ==================== 잠금 관리 기능 ====================
        let keepLockInterval = null;
        let fundCode = null;
        let sessionId = null;

        function initEditLock() {
            // DOM에서 값 가져오기
            const fundCodeElement = document.getElementById('fundCode');
            const sessionIdElement = document.getElementById('sessionId');
            
            if (!fundCodeElement || !sessionIdElement) {
                return; // 잠금 오류 페이지이거나 필요한 정보가 없음
            }
            
            fundCode = fundCodeElement.value;
            sessionId = sessionIdElement.value;
            
            if (!fundCode || !sessionId) {
                return; // 값이 없으면 종료
            }

            // 30초마다 잠금 갱신
            keepLockInterval = setInterval(function() {
                keepLock();
            }, 30000); // 30초

            // 페이지 이탈 시 잠금 해제
            window.addEventListener('beforeunload', function(e) {
                console.log('beforeunload 이벤트 발생 - 잠금 해제');
                unlock();
            });
            
            // 뒤로가기 감지
            window.addEventListener('popstate', function(e) {
                console.log('popstate 이벤트 발생 (뒤로가기) - 잠금 해제');
                unlock();
            });
            
            // 페이지 숨김 시 잠금 해제 (뒤로가기 등)
            window.addEventListener('pagehide', function(e) {
                console.log('pagehide 이벤트 발생 - 잠금 해제');
                // pagehide는 페이지가 완전히 숨겨지기 전에 발생하므로 확실하게 잠금 해제
                unlock();
            });
            
            // unload 이벤트도 추가 (더 확실하게)
            window.addEventListener('unload', function(e) {
                console.log('unload 이벤트 발생 - 잠금 해제');
                unlock();
            });
            
            // 페이지 숨김 시 잠금 해제 (탭 전환, 브라우저 최소화 등)
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.log('visibilitychange 이벤트 발생 (탭 전환) - 잠금 해제');
                    unlock();
                }
            });

            // 폼 제출 시 잠금 해제 (성공적으로 제출되면)
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function() {
                    console.log('폼 제출 - 잠금 갱신 중지');
                    // 폼 제출 후 잠금 해제는 서버에서 처리
                    clearInterval(keepLockInterval);
                });
            }
            
            // 취소 버튼 클릭 시 잠금 해제
            const cancelBtn = document.querySelector('a.btn-secondary[href*="/admin/product/pending"]');
            if (cancelBtn) {
                console.log('취소 버튼 찾음');
                cancelBtn.addEventListener('click', function(e) {
                    console.log('취소 버튼 클릭 - 잠금 해제');
                    unlock();
                    // 약간의 지연을 주어 잠금 해제 요청이 전송되도록 함
                    setTimeout(function() {
                        // 기본 동작은 그대로 진행
                    }, 200);
                }, true); // capture phase에서 실행
            } else {
                console.log('취소 버튼을 찾을 수 없습니다');
            }
            
            // 모든 링크 클릭 시 잠금 해제 (다른 페이지로 이동하는 경우)
            document.addEventListener('click', function(e) {
                const target = e.target.closest('a[href]');
                if (target) {
                    const href = target.getAttribute('href');
                    // pending 페이지로 가는 경우 잠금 해제
                    if (href && (href.includes('/admin/product/pending') || (href.includes('/admin/product') && !href.includes('/edit')))) {
                        console.log('링크 클릭으로 페이지 이동:', href, '- 잠금 해제');
                        unlock();
                        // 약간의 지연을 주어 잠금 해제 요청이 전송되도록 함
                        setTimeout(function() {
                            // 기본 동작은 그대로 진행
                        }, 200);
                    }
                }
            }, true); // capture phase에서 실행
        }

        // 잠금 갱신
        function keepLock() {
            if (!fundCode || !sessionId) return;

            const token = document.querySelector('input[name="_csrf"]')?.value;
            const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';

            const formData = new FormData();
            formData.append('fundCode', fundCode);

            fetch('/bnk/admin/product/edit/keep-lock', {
                method: 'POST',
                headers: {
                    [header]: token
                },
                body: formData
            }).catch(function(error) {
                console.error('잠금 갱신 실패:', error);
            });
        }

        // 잠금 해제
        function unlock() {
            // fundCode와 sessionId를 DOM에서 가져오기
            const fundCodeElement = document.getElementById('fundCode');
            const sessionIdElement = document.getElementById('sessionId');
            
            if (!fundCodeElement || !sessionIdElement) {
                console.log('잠금 해제 실패: fundCode 또는 sessionId 요소를 찾을 수 없습니다.');
                return;
            }
            
            const currentFundCode = fundCodeElement.value;
            const currentSessionId = sessionIdElement.value;
            
            if (!currentFundCode || !currentSessionId) {
                console.log('잠금 해제 실패: fundCode 또는 sessionId 값이 없습니다.');
                return;
            }

            const token = document.querySelector('input[name="_csrf"]')?.value;
            const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';

            console.log('잠금 해제 시도:', currentFundCode);

            // fetch의 keepalive 옵션을 사용하여 페이지 이탈 시에도 요청 전송
            // keepalive: true는 페이지가 닫혀도 요청이 완료될 때까지 기다림
            const formData = new FormData();
            formData.append('fundCode', currentFundCode);
            
            fetch('/bnk/admin/product/edit/unlock', {
                method: 'POST',
                headers: {
                    [header]: token
                },
                body: formData,
                keepalive: true
            }).catch(function(error) {
                console.error('잠금 해제 실패:', error);
            });
        }
        /*]]>*/
    </script>
    <!-- 사이드바 스크립트 -->
    <div th:replace="~{admin/_sidebar :: sidebar-script}"></div>
</body>
</html>

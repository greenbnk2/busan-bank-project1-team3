<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>펀드 등록 대기 - 은행 펀드 상품 관리자</title>
    <link rel="stylesheet" th:href="@{/css/admin/admin_styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin/adminproduct.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<!--
    이름 : 설유진
    내용 : 펀드 관리
-->
<body>
    <!-- 사이드바 Fragment -->
    <div th:replace="~{admin/_sidebar :: sidebar('product-pending')}"></div>

    <div class="main-content">
        <!-- 헤더 Fragment -->
        <div th:replace="~{admin/_header :: header}"></div>
        <div class="main-content-body">
            <div class="container">
            <!-- 페이지 헤더 -->
            <header class="page-header">
                <h1>펀드 관리</h1>
                <div class="header-actions">
                    <a th:href="@{/admin/product}" class="btn btn-secondary">목록으로</a>
                    <a th:href="@{/admin/product/register}" class="btn btn-red">펀드신규등록</a>
                </div>
            </header>

            <!-- 검색 섹션 -->
            <div class="search-section">
                <form th:action="@{/admin/product/pending}" method="get" style="margin: 0;">
                <table class="search-table">
                    <tbody>
                        <tr>
                            <td class="search-label">검색조건</td>
                            <td class="search-inputs">
                                    <select class="form-select search-select-small" id="searchNameSelect" name="searchType">
                                        <option value="name">펀드명</option>
                                        <option value="code">상품코드</option>
                                        <option value="type">유형</option>
                                </select>
                                    <input type="text" class="form-input search-input-large" id="searchName" name="keyword" placeholder="입력하세요" th:value="${pageRequestDTO != null ? pageRequestDTO.keyword : ''}">
                            </td>
                        </tr>
                        <tr>
                            <td class="search-label">펀드분류</td>
                            <td class="search-inputs">
                                <select class="form-select search-select-medium" id="searchCategory" name="category">
                                    <option value="">전체</option>
                                    <option value="EQTY"
                                            th:selected="${pageRequestDTO != null && pageRequestDTO.category == 'EQTY'}">주식형</option>
                                    <option value="MIXEQ"
                                            th:selected="${pageRequestDTO != null && pageRequestDTO.category == 'MIXEQ'}">혼합주식형</option>
                                    <option value="MIXBD"
                                            th:selected="${pageRequestDTO != null && pageRequestDTO.category == 'MIXBD'}">혼합채권형</option>
                                    <option value="BOND"
                                            th:selected="${pageRequestDTO != null && pageRequestDTO.category == 'BOND'}">채권형</option>
                                    <option value="MMF"
                                            th:selected="${pageRequestDTO != null and pageRequestDTO.category == 'MMF'}">단기금융</option>
                                    <option value="INVC"
                                            th:selected="${pageRequestDTO != null and pageRequestDTO.category == 'INVC'}">투자계약</option>
                                    <option value="DERIV"
                                            th:selected="${pageRequestDTO != null and pageRequestDTO.category == 'DERIV'}">파생상품</option>
                                    <option value="REIT"
                                            th:selected="${pageRequestDTO != null and pageRequestDTO.category == 'REIT'}">부동산</option>
                                    <option value="PHYS"
                                            th:selected="${pageRequestDTO != null and pageRequestDTO.category == 'PHYS'}">실물</option>
                                    <option value="FOF"
                                            th:selected="${pageRequestDTO != null and pageRequestDTO.category == 'FOF'}">재간접</option>
                                    <option value="VINS"
                                            th:selected="${pageRequestDTO != null and pageRequestDTO.category == 'VINS'}">변액보험</option>
                                    <option value="SPEC"
                                            th:selected="${pageRequestDTO != null and pageRequestDTO.category == 'SPEC'}">특별자산</option>
                                    <option value="MIXAS"
                                            th:selected="${pageRequestDTO != null and pageRequestDTO.category == 'MIXAS'}">혼합자산</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="search-label">상태</td>
                            <td class="search-inputs">
                                <div class="status-radio-group">
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="" checked>
                                        <span>전체</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="등록">
                                        <span>등록</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="등록대기">
                                        <span>등록대기</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="등록반려">
                                        <span>등록반려</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="운용대기">
                                        <span>운용대기</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="운용중">
                                        <span>운용중</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="운용중단">
                                        <span>운용중단</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="수정">
                                        <span>수정</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="수정대기">
                                        <span>수정대기</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="수정완료">
                                        <span>수정완료</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="수정반려">
                                        <span>수정반려</span>
                                    </label>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="search-actions">
                        <button class="btn btn-search" type="submit">조회</button>
                        <button class="btn btn-secondary" type="button" th:onclick="|location.href='@{/admin/product/pending}'|">초기화</button>
                </div>
                </form>
            </div>

            <!-- 등록 대기 목록 테이블 -->
            <div class="table-section">
                <div class="table-info">
                    <span>
                            총
                            <strong th:text="${pageResponse != null ? pageResponse.total : 0}">0</strong>건
                        </span>
                    <span class="pagination-info"
                          th:if="${pageResponse != null and pageResponse.total > 0}">
                            현재:
                            <span th:text="${pageRequestDTO.pg}">1</span> /
                            <span th:text="${(pageResponse.total + pageRequestDTO.size - 1) / pageRequestDTO.size}">1</span>
                            페이지
                        </span>
                </div>
                <table class="product-table">
                    <thead>
                        <tr>
                            <th>상품코드</th>
                            <th>상품명</th>
                            <th>회사명</th>
                            <th>상태</th>
                            <th>최근수정일시</th>
                            <th>수정</th>
                            <th>운영관리</th>
                            <th>승인요청</th>
                            <th>반영예약</th>
                        </tr>
                    </thead>
                    <tbody id="pendingTableBody">
                        <tr th:each="dto, stat : ${dtoList}" th:attr="data-product-id=${dto.fundCode}">
                            <td th:text="${dto.fundCode}"></td>
                            <td>
                                <span class="product-name-link"
                                      th:text="${dto.fundName}"
                                      th:attr="title=${dto.fundName}"></span>
                            </td>
                            <td>
                                <span class="company-name"
                                      th:text="${dto.operatorName}"
                                      th:attr="title=${dto.operatorName}"></span>
                            </td>
                            <td>
                                <span class="status-text" th:text="${dto.operStatus}"></span>
                            </td>
                            <td th:text="${dto.lastUpdDate}"></td>
                            <td>
                                <button class="action-btn edit" th:attr="data-fund-code=${dto.fundCode}"
                                        onclick="editProduct(this.dataset.fundCode)">수정</button>
                            </td>
                            <td>
                                <button class="action-btn stop"
                                        th:attr="data-fund-code=${dto.fundCode}"
                                        onclick="stopFund(this.dataset.fundCode)"
                                        th:style="${dto.operStatus == '운용중'} ? '' : 'display:none'">운용중단</button>

                                <button class="action-btn resume"
                                        th:attr="data-fund-code=${dto.fundCode}"
                                        onclick="resumeFund(this.dataset.fundCode)"
                                        th:style="${dto.operStatus == '운용중단'} ? '' : 'display:none'">운용재개</button>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn approval" th:attr="data-fund-code=${dto.fundCode}"
                                            onclick="requestApproval(this.dataset.fundCode)">승인요청</button>
                                </div>
                            </td>
                            <td>
                                <button class="action-btn reserve" th:attr="data-fund-code=${dto.fundCode}"
                                        onclick="reserveProduct(this.dataset.fundCode)">반영예약</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="pagination"
                     th:if="${pageResponse != null and pageResponse.total > 0}">

                    <!-- 이전 버튼 -->
                    <button class="page-btn prev"
                            th:if="${pageResponse.prev}"
                            th:onclick="|location.href='@{/admin/product/pending(
                            pg=${pageResponse.start - 1},
                            size=${pageRequestDTO.size},
                            searchType=${pageRequestDTO.searchType},
                            keyword=${pageRequestDTO.keyword},
                            category=${pageRequestDTO.category},
                            status=${pageRequestDTO.status}
                            )}'|">
                        &lt;
                    </button>

                    <!-- 페이지 번호 -->
                    <div class="page-numbers">
                        <button class="page-number"
                                th:each="p : ${#numbers.sequence(pageResponse.start, pageResponse.end)}"
                                th:text="${p}"
                                th:classappend="${p == pageRequestDTO.pg} ? ' active'"
                                th:onclick="|location.href='@{/admin/product/pending(
                                pg=${p},
                                size=${pageRequestDTO.size},
                                searchType=${pageRequestDTO.searchType},
                                keyword=${pageRequestDTO.keyword},
                                category=${pageRequestDTO.category},
                                status=${pageRequestDTO.status}
                                )}'|">
                        </button>
                    </div>

                    <!-- 다음 버튼 -->
                    <button class="page-btn next"
                            th:if="${pageResponse.next}"
                            th:onclick="|location.href='@{/admin/product/pending(
                            pg=${pageResponse.end + 1},
                            size=${pageRequestDTO.size},
                            searchType=${pageRequestDTO.searchType},
                            keyword=${pageRequestDTO.keyword},
                            category=${pageRequestDTO.category},
                            status=${pageRequestDTO.status}
                            )}'|">
                        &gt;
                    </button>

                </div>
            </div>
            <!-- 푸터 영역 -->
            <footer class="admin-footer"></footer>
        </div>
        </div>
    </div>

    <!-- 상품 세부사항 모달 -->
    <div id="productDetailModal" class="modal">
        <div class="modal-content fund-detail-modal">
            <div class="modal-header">
                <div class="fund-detail-title">
                    <h2>펀드요약정보</h2>
                    <div class="fund-name-section">
                        <div class="fund-full-name" id="fundFullName"></div>
                        <div class="fund-code" id="fundCode"></div>
                    </div>
                </div>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 상품 상세 정보가 여기에 표시됩니다 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">닫기</button>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const editUrl = /*[[@{/admin/product/edit}]]*/ '';
        const stopUrl = /*[[@{/admin/product/stop}]]*/ '';
        const resumeUrl = /*[[@{/admin/product/resume}]]*/ '';
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

        function editProduct(fundCode) {
            location.href = editUrl + '?fundCode=' + fundCode;
        }

        function executeFundAction(url, fundCode, successMessage, nextStatus) {
            const headers = {
                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
            };
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            const params = new URLSearchParams();
            params.append('fundCode', fundCode);

            return fetch(url, {
                method: 'POST',
                headers,
                body: params.toString()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('요청 처리 중 오류가 발생했습니다.');
                    }
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.indexOf('application/json') !== -1) {
                        return response.json();
                    }
                    return null;
                })
                .then(() => {
                    alert(successMessage);
                    updateButtonVisibility(fundCode, nextStatus);
                })
                .catch(error => {
                    console.error(error);
                    alert('요청을 처리하지 못했습니다. 잠시 후 다시 시도해주세요.');
                });
        }

        // 운용중단 함수
        function stopFund(fundCode) {
            if (!confirm('운용을 중단하시겠습니까?')) {
                return;
            }
            executeFundAction(stopUrl, fundCode, '운용이 중단되었습니다.', '운용중단');
        }

        // 운용재개 함수
        function resumeFund(fundCode) {
            if (!confirm('운용을 재개하시겠습니까?')) {
                return;
            }
            executeFundAction(resumeUrl, fundCode, '운용이 재개되었습니다.', '운용중');
        }

        // 반영예약 함수
        function reserveProduct(fundCode) {
            if (confirm('변경사항을 반영예약하시겠습니까?')) {
                // TODO: 반영예약 API 호출
                alert('반영예약이 완료되었습니다.');
            }
        }

        // 승인요청 함수
        function requestApproval(fundCode) {
            if (confirm('승인을 요청하시겠습니까?')) {
                // TODO: 승인요청 API 호출
                alert('승인요청이 완료되었습니다.');
            }
        }

        // 상태에 따라 버튼 표시/숨김 처리
        function updateButtonVisibility(fundCode, status) {
            const row = document.querySelector(`tr[data-product-id="${fundCode}"]`);
            if (!row) return;

            const stopBtn = row.querySelector('.action-btn.stop');
            const resumeBtn = row.querySelector('.action-btn.resume');
            const statusBadge = row.querySelector('.status-text');

            // 상태에 따라 운용중단 또는 운용재개 버튼 표시
            if (status === '운용중') {
                if (stopBtn) stopBtn.style.display = 'inline-block';
                if (resumeBtn) resumeBtn.style.display = 'none';
            } else if (status === '운용중단') {
                if (stopBtn) stopBtn.style.display = 'none';
                if (resumeBtn) resumeBtn.style.display = 'inline-block';
            } else {
                if (stopBtn) stopBtn.style.display = 'none';
                if (resumeBtn) resumeBtn.style.display = 'none';
            }

            if (statusBadge) {
                statusBadge.textContent = status;
                statusBadge.className = 'status-text';
            }
        }

        // 상태에 따른 CSS 클래스 반환
        function getStatusClass(status) {
            const statusMap = {
                '운용중': 'active',
                '수정': 'modifying',
                '수정대기': 'modifying',
                '수정완료': 'modifying',
                '수정반려': 'modifying',
                '등록': 'pending',
                '등록대기': 'pending',
                '등록반려': 'pending',
                '운용대기': 'pending',
                '운용중단': 'stopped'
            };
            return statusMap[status] || 'pending';
        }

        // 페이지 로드 시 상태에 따라 버튼 표시/숨김 처리
        function initializeButtonVisibility() {
            const rows = document.querySelectorAll('#pendingTableBody tr');
            rows.forEach(row => {
                const statusBadge = row.querySelector('.status-text');
                if (statusBadge) {
                    const status = statusBadge.textContent.trim();
                    const fundCode = row.getAttribute('data-product-id') || 
                                    row.querySelector('.action-btn.edit')?.dataset?.fundCode;
                    
                    if (fundCode) {
                        row.setAttribute('data-product-id', fundCode);
                        updateButtonVisibility(fundCode, status);
                    }
                }
            });
        }


        function viewPendingDetail(productId) {
            const product = pendingProductDetailData[productId];
            if (!product) {
                alert('상품 정보를 찾을 수 없습니다.');
                return;
            }

            // 헤더 정보 설정
            document.getElementById('fundFullName').textContent = product.productName;
            document.getElementById('fundCode').textContent = product.productCode;

        }
        
        let returnChart = null;
        let priceChart = null;
        let assetChart = null;
        
        // 벤치마크 지수 데이터 (샘플 데이터 - 날짜에 맞춤)
        const benchmarkData = {
            kospi: [8500, 8600, 8700, 8800, 8900, 9000],
            kosdaq: [2400, 2450, 2500, 2550, 2600, 2650],
            govt: [0.5, 1.2, 2.5, 3.5, 2.8, 3.2],
            corp: [0.8, 1.5, 3.0, 4.0, 3.2, 3.8]
        };
        
        // 벤치마크 지수 색상
        const benchmarkColors = {
            kospi: '#4CAF50',
            kosdaq: '#9C27B0',
            govt: '#FF69B4',
            corp: '#607D8B'
        };
        

        // 상품명 35자로 제한
        function truncateProductNames() {
            const productNameLinks = document.querySelectorAll('.product-name-link');
            productNameLinks.forEach(link => {
                let fullText = link.getAttribute('title') || link.textContent.trim();
                
                if (!link.getAttribute('title')) {
                    link.setAttribute('title', fullText);
                }
                
                if (fullText.length > 35) {
                    link.textContent = fullText.substring(0, 35) + '...';
                } else {
                    link.textContent = fullText;
                }
            });
        }

        // 회사명 6자로 제한
        function truncateCompanyNames() {
            const companyNameSpans = document.querySelectorAll('.company-name');
            companyNameSpans.forEach(span => {
                let fullText = span.getAttribute('title') || span.textContent.trim();

                if (!span.getAttribute('title')) {
                    span.setAttribute('title', fullText);
                }

                if (fullText.length > 6) {
                    span.textContent = fullText.substring(0, 6) + '...';
                } else {
                    span.textContent = fullText;
                }
            });
        }

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', function() {
            truncateProductNames();
            truncateCompanyNames();
            initializeButtonVisibility();
        });
        /*]]>*/
    </script>
    <!-- 사이드바 스크립트 -->
    <div th:replace="~{admin/_sidebar :: sidebar-script}"></div>
</body>
</html>


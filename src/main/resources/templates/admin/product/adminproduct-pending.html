<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>펀드 등록 대기 - 은행 펀드 상품 관리자</title>
    <link rel="stylesheet" th:href="@{/css/admin/admin_styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin/adminproduct.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<!--
    이름 : 설유진
    내용 : 펀드 관리
-->
<body>
    <!-- 사이드바 Fragment -->
    <div th:replace="~{admin/_sidebar :: sidebar('product-pending')}"></div>

    <div class="main-content">
        <!-- 헤더 Fragment -->
        <div th:replace="~{admin/_header :: header}"></div>
        <div class="main-content-body">
            <div class="container">
            <!-- 페이지 헤더 -->
            <header class="page-header">
                <h1>펀드 관리</h1>
                <div class="header-actions">
                    <a th:href="@{/admin/product}" class="btn btn-secondary">목록으로</a>
                    <a th:href="@{/admin/product/register}" class="btn btn-red">펀드신규등록</a>
                </div>
            </header>

            <!-- 검색 섹션 -->
            <div class="search-section">
                <form th:action="@{/admin/product/pending}" method="get" style="margin: 0;">
                <table class="search-table">
                    <tbody>
                        <tr>
                            <td class="search-label">검색조건</td>
                            <td class="search-inputs">
                                    <select class="form-select search-select-small" id="searchNameSelect" name="searchType">
                                        <option value="name">펀드명</option>
                                        <option value="code">상품코드</option>
                                        <option value="type">유형</option>
                                </select>
                                    <input type="text" class="form-input search-input-large" id="searchName" name="keyword" placeholder="입력하세요" th:value="${pageRequestDTO != null ? pageRequestDTO.keyword : ''}">
                            </td>
                        </tr>
                        <tr>
                            <td class="search-label">펀드분류</td>
                            <td class="search-inputs">
                                <select class="form-select search-select-medium" id="searchCategory" name="category">
                                    <option value=""
                                            th:selected="${pageRequestDTO == null or pageRequestDTO.category == null or pageRequestDTO.category == ''}">
                                        전체
                                    </option>
                                    <option th:each="cat : ${categoryList}"
                                            th:value="${cat.categoryCode}"
                                            th:text="${cat.categoryName}"
                                            th:selected="${pageRequestDTO != null and pageRequestDTO.category == cat.categoryCode}">
                                    </option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="search-label">상태</td>
                            <td class="search-inputs">
                                <div class="status-radio-group">
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="" checked>
                                        <span>전체</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="등록">
                                        <span>등록</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="등록대기">
                                        <span>등록대기</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="등록반려">
                                        <span>등록반려</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="등록완료"
                                                   th:checked="${pageRequestDTO != null && pageRequestDTO.status == '등록완료'}">
                                        <span>등록완료</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="운용대기">
                                        <span>운용대기</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="운용중">
                                        <span>운용중</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="운용중단">
                                        <span>운용중단</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="수정">
                                        <span>수정</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="수정대기">
                                        <span>수정대기</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="수정완료">
                                        <span>수정완료</span>
                                    </label>
                                    <label class="status-radio-label">
                                            <input type="radio" name="status" value="수정반려">
                                        <span>수정반려</span>
                                    </label>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="search-actions">
                        <button class="btn btn-search" type="submit">조회</button>
                        <button class="btn btn-secondary" type="button" th:onclick="|location.href='@{/admin/product/pending}'|">초기화</button>
                </div>
                </form>
            </div>

            <!-- 등록 대기 목록 테이블 -->
            <div class="table-section">
                <div class="table-info">
                    <span>
                            총
                            <strong th:text="${pageResponse != null ? pageResponse.total : 0}">0</strong>건
                        </span>
                    <span class="pagination-info"
                          th:if="${pageResponse != null and pageResponse.total > 0}">
                            현재:
                            <span th:text="${pageRequestDTO.pg}">1</span> /
                            <span th:text="${(pageResponse.total + pageRequestDTO.size - 1) / pageRequestDTO.size}">1</span>
                            페이지
                        </span>
                </div>
                <table class="product-table">
                    <thead>
                        <tr>
                            <th>상품코드</th>
                            <th>상품명</th>
                            <th>회사명</th>
                            <th>상태</th>
                            <th>최근수정일시</th>
                            <th>수정</th>
                            <th>운영관리</th>
                            <th>승인요청</th>
                            <th>반영예약</th>
                        </tr>
                    </thead>
                    <tbody id="pendingTableBody">
                        <tr th:each="dto, stat : ${dtoList}" 
                            th:attr="data-product-id=${dto.fundCode},data-fund-code=${dto.fundCode},data-rev-status=${dto.revStatus}">
                            <td th:text="${dto.fundCode}"></td>
                            <td>
                                <span class="product-name-link"
                                      th:text="${dto.fundName}"
                                      th:attr="title=${dto.fundName}"></span>
                            </td>
                            <td>
                                <span class="company-name"
                                      th:text="${dto.operatorName}"
                                      th:attr="title=${dto.operatorName}"></span>
                            </td>
                            <td>
                                <span class="status-text" th:text="${dto.operStatus}"></span>
                            </td>
                            <td>
                                <span th:text="${dto.lastUpdDate}"></span>
                                <!-- 잠금 상태일 때 수정중 표시 -->
                                <span th:if="${lockStatusMap != null and lockStatusMap[dto.fundCode] == true}" 
                                      data-lock-status="true"
                                      style="margin-left: 10px; color: #cd1317; font-weight: 600;">
                                    [수정중]
                                </span>
                                <!-- REV_STATUS 표시 -->
                                <span th:if="${dto.revStatus != null and dto.revStatus != ''}"
                                      style="margin-left: 10px; color: #666;">
                                    [<span th:text="${dto.revStatus}"></span>]
                                </span>
                            </td>
                            <td>
                                <button class="action-btn edit" 
                                        th:attr="data-fund-code=${dto.fundCode}"
                                        th:disabled="${(dto.operStatus != '운용대기' and dto.operStatus != '운용중' and dto.operStatus != '운용중단') or (lockStatusMap != null and lockStatusMap[dto.fundCode] == true)}"
                                        onclick="editProduct(this.dataset.fundCode)">수정</button>
                            </td>
                            <td>
                                <button class="action-btn stop"
                                        th:attr="data-fund-code=${dto.fundCode}"
                                        th:style="${dto.operStatus == '운용중'} ? '' : 'display:none'"
                                        onclick="stopFund(this.dataset.fundCode)">운용중단</button>

                                <button class="action-btn resume"
                                        th:attr="data-fund-code=${dto.fundCode}"
                                        th:style="${dto.operStatus == '운용중단'} ? '' : 'display:none'"
                                        onclick="resumeFund(this.dataset.fundCode)">운용재개</button>

                                <button class="action-btn waiting"
                                        th:attr="data-fund-code=${dto.fundCode}"
                                        th:style="${dto.operStatus != '운용중' and dto.operStatus != '운용중단'} ? '' : 'display:none'"
                                        disabled>운용대기</button>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn approval" 
                                            th:attr="data-fund-code=${dto.fundCode},data-fund-name=${dto.fundName}"
                                            th:disabled="${(dto.operStatus != '등록' and dto.operStatus != '등록대기' and dto.operStatus != '수정') and (dto.revStatus == null or dto.revStatus != '대기')}"
                                            onclick="requestApproval(this)">승인요청</button>
                                </div>
                            </td>
                            <td>
                                <button class="action-btn reserve" th:attr="data-fund-code=${dto.fundCode}"
                                        th:disabled="${(dto.operStatus != '등록완료' and dto.operStatus != '수정완료' and dto.operStatus != '운용대기') and (dto.revStatus == null or dto.revStatus != '수정완료')}"
                                        onclick="reserveProduct(this)">반영예약</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="pagination"
                     th:if="${pageResponse != null and pageResponse.total > 0}">

                    <!-- 이전 버튼 -->
                    <button class="page-btn prev"
                            th:if="${pageResponse.prev}"
                            th:onclick="|location.href='@{/admin/product/pending(
                            pg=${pageResponse.start - 1},
                            size=${pageRequestDTO.size},
                            searchType=${pageRequestDTO.searchType},
                            keyword=${pageRequestDTO.keyword},
                            category=${pageRequestDTO.category},
                            status=${pageRequestDTO.status}
                            )}'|">
                        &lt;
                    </button>

                    <!-- 페이지 번호 -->
                    <div class="page-numbers">
                        <button class="page-number"
                                th:each="p : ${#numbers.sequence(pageResponse.start, pageResponse.end)}"
                                th:text="${p}"
                                th:classappend="${p == pageRequestDTO.pg} ? ' active'"
                                th:onclick="|location.href='@{/admin/product/pending(
                                pg=${p},
                                size=${pageRequestDTO.size},
                                searchType=${pageRequestDTO.searchType},
                                keyword=${pageRequestDTO.keyword},
                                category=${pageRequestDTO.category},
                                status=${pageRequestDTO.status}
                                )}'|">
                        </button>
                    </div>

                    <!-- 다음 버튼 -->
                    <button class="page-btn next"
                            th:if="${pageResponse.next}"
                            th:onclick="|location.href='@{/admin/product/pending(
                            pg=${pageResponse.end + 1},
                            size=${pageRequestDTO.size},
                            searchType=${pageRequestDTO.searchType},
                            keyword=${pageRequestDTO.keyword},
                            category=${pageRequestDTO.category},
                            status=${pageRequestDTO.status}
                            )}'|">
                        &gt;
                    </button>

                </div>
            </div>
            <!-- 푸터 영역 -->
            <footer class="admin-footer"></footer>
        </div>
        </div>
    </div>


    <!-- 승인요청 모달 -->
    <div id="approvalRequestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>승인요청</h2>
                <span class="close" onclick="closeApprovalModal()">&times;</span>
            </div>
            <form th:action="@{/admin/product/approval}" method="post" id="approvalRequestForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="modal-body">
                    <table class="form-table">
                        <tbody>
                            <tr>
                                <th>상품코드</th>
                                <td>
                                    <input type="text" class="form-input" name="fundCode" id="approvalProductCode" readonly>
                                </td>
                            </tr>
                            <tr>
                                <th>상품명</th>
                                <td>
                                    <input type="text" class="form-input" id="approvalProductName" readonly>
                                </td>
                            </tr>
                            <tr>
                                <th>상태</th>
                                <td>
                                    <input type="text" class="form-input" name="apprType" id="approvalStatus" readonly>
                                </td>
                            </tr>
                            <tr>
                                <th>요청자</th>
                                <td>
                                    <input type="text" class="form-input" name="requester" id="approvalRequester" 
                                           th:value="${#authentication.principal.displayName}">
                                </td>
                            </tr>
                            <tr>
                                <th>요청사유</th>
                                <td>
                                    <textarea class="form-textarea" name="requestReason" id="approvalReason" rows="4" placeholder="요청 사유를 입력하세요" required></textarea>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeApprovalModal()">취소</button>
                    <button type="submit" class="btn btn-red">요청</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 반영예약 모달 -->
    <div id="reserveProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>반영예약</h2>
                <span class="close" onclick="closeReserveModal()">&times;</span>
            </div>
            <div class="modal-body">
                <table class="form-table">
                    <tbody>
                        <tr>
                            <th>상품코드</th>
                            <td>
                                <input type="text" class="form-input" id="reserveProductCode" readonly>
                            </td>
                        </tr>
                        <tr>
                            <th>상품명</th>
                            <td>
                                <input type="text" class="form-input" id="reserveProductName" readonly>
                            </td>
                        </tr>
                        <tr>
                            <th>상태</th>
                            <td>
                                <input type="text" class="form-input" id="reserveStatus" readonly>
                            </td>
                        </tr>
                        <tr>
                            <th>반영일시</th>
                            <td>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="date" class="form-input" id="reserveDate" style="width: 200px;">
                                        <input type="time" class="form-input" id="reserveTime" style="width: 150px;">
                                    </div>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" id="immediateApply" onchange="toggleReserveDateTime()">
                                        <span>즉시 반영</span>
                                    </label>
                                    <div id="immediateApplyNotice" style="display: none; color: #cd1317; font-size: 14px; margin-top: 5px;">
                                        ※ 변경사항이 즉시 반영됩니다.<br>
                                        ※ 주의하세요.
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <!-- 숨겨진 폼 -->
                <form id="reserveForm" method="post" action="/bnk/admin/product/reserve" style="display: none;">
                    <input type="hidden" name="fundCode" id="reserveFormFundCode">
                    <input type="hidden" name="date" id="reserveFormDate">
                    <!-- CSRF 토큰 -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                </form>
                
                <button class="btn btn-secondary" onclick="closeReserveModal()">취소</button>
                <button class="btn btn-red" onclick="submitReserveRequest()">예약</button>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const editUrl = /*[[@{/admin/product/edit}]]*/ '';
        const stopUrl = /*[[@{/admin/product/stop}]]*/ '';
        const resumeUrl = /*[[@{/admin/product/resume}]]*/ '';
        const checkLocksUrl = /*[[@{/admin/product/pending/check-locks}]]*/ '';
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

        function editProduct(fundCode) {
            // 잠금 상태 확인
            const row = document.querySelector(`tr[data-fund-code="${fundCode}"]`);
            const editBtn = row?.querySelector('.action-btn.edit');
            const statusBadge = row?.querySelector('.status-text');
            const status = statusBadge ? statusBadge.textContent.trim() : '';
            
            // 상태 체크: 운용대기, 운용중, 운용중단일 때만 수정 가능
            const isEditAllowed = (status === '운용대기' || status === '운용중' || status === '운용중단');
            if (!isEditAllowed) {
                alert('운용대기, 운용중, 운용중단 상태에서만 수정할 수 있습니다.');
                return;
            }
            
            if (editBtn && editBtn.disabled) {
                alert('다른 사용자가 수정 중입니다. 잠시 후 다시 시도해주세요.');
                return;
            }
            
            location.href = editUrl + '?fundCode=' + fundCode;
        }

        function executeFundAction(url, fundCode, successMessage, nextStatus) {
            const headers = {
                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
            };
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            const params = new URLSearchParams();
            params.append('fundCode', fundCode);

            return fetch(url, {
                method: 'POST',
                headers,
                body: params.toString()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('요청 처리 중 오류가 발생했습니다.');
                    }
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.indexOf('application/json') !== -1) {
                        return response.json();
                    }
                    return null;
                })
                .then(() => {
                    alert(successMessage);
                    updateButtonVisibility(fundCode, nextStatus);
                })
                .catch(error => {
                    console.error(error);
                    alert('요청을 처리하지 못했습니다. 잠시 후 다시 시도해주세요.');
                });
        }

        // 운용중단 함수
        function stopFund(fundCode) {
            // 버튼이 비활성화되어 있으면 동작하지 않음
            const button = event?.target || document.querySelector(`button[data-fund-code="${fundCode}"].stop`);
            if (button && button.disabled) {
                return;
            }
            
            if (!confirm('운용을 중단하시겠습니까?')) {
                return;
            }
            executeFundAction(stopUrl, fundCode, '운용이 중단되었습니다.', '운용중단');
        }

        // 운용재개 함수
        function resumeFund(fundCode) {
            // 버튼이 비활성화되어 있으면 동작하지 않음
            const button = event?.target || document.querySelector(`button[data-fund-code="${fundCode}"].resume`);
            if (button && button.disabled) {
                return;
            }
            
            if (!confirm('운용을 재개하시겠습니까?')) {
                return;
            }
            executeFundAction(resumeUrl, fundCode, '운용이 재개되었습니다.', '운용중');
        }

        // 반영예약 함수
        function reserveProduct(button) {
            // 비활성화된 버튼이면 동작하지 않음
            if (button.disabled) {
                return;
            }
            
            const fundCode = button.dataset.fundCode;
            
            // 행에서 정보 가져오기
            const row = button.closest('tr');
            const productCode = row.querySelector('td:first-child')?.textContent?.trim() || fundCode;
            const productName = row.querySelector('.product-name-link')?.getAttribute('title') || 
                               row.querySelector('.product-name-link')?.textContent?.trim() || '';
            const status = row.querySelector('.status-text')?.textContent?.trim() || '';
            
            // 모달에 데이터 채우기
            document.getElementById('reserveProductCode').value = productCode;
            document.getElementById('reserveProductName').value = productName;
            document.getElementById('reserveStatus').value = status;
            
            // 반영일시 기본값 설정 (현재 날짜/시간)
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            document.getElementById('reserveDate').value = `${year}-${month}-${day}`;
            document.getElementById('reserveTime').value = `${hours}:${minutes}`;
            document.getElementById('immediateApply').checked = false;
            
            // 모달 표시
            document.getElementById('reserveProductModal').classList.add('active');
        }

        // 즉시 반영 체크박스 토글
        function toggleReserveDateTime() {
            const immediateApply = document.getElementById('immediateApply');
            const reserveDate = document.getElementById('reserveDate');
            const reserveTime = document.getElementById('reserveTime');
            const immediateApplyNotice = document.getElementById('immediateApplyNotice');
            
            if (immediateApply.checked) {
                // 즉시 반영이 체크되면 날짜/시간 입력 필드 비활성화
                reserveDate.disabled = true;
                reserveTime.disabled = true;
                // 안내 문구 표시
                immediateApplyNotice.style.display = 'block';
            } else {
                // 체크 해제되면 날짜/시간 입력 필드 활성화
                reserveDate.disabled = false;
                reserveTime.disabled = false;
                // 안내 문구 숨김
                immediateApplyNotice.style.display = 'none';
            }
        }

        // 반영예약 모달 닫기
        function closeReserveModal() {
            document.getElementById('reserveProductModal').classList.remove('active');
        }

        // 반영예약 제출
        function submitReserveRequest() {
            const productCode = document.getElementById('reserveProductCode').value;
            const productName = document.getElementById('reserveProductName').value;
            const status = document.getElementById('reserveStatus').value;
            const immediateApply = document.getElementById('immediateApply').checked;
            const reserveDate = document.getElementById('reserveDate').value;
            const reserveTime = document.getElementById('reserveTime').value;
            
            // 즉시 반영이 체크되어 있지 않으면 날짜/시간 유효성 검사
            if (!immediateApply) {
                if (!reserveDate) {
                    alert('반영일자를 선택해주세요.');
                    return;
                }
                
                if (!reserveTime) {
                    alert('반영시간을 선택해주세요.');
                    return;
                }
            }
            
            // 날짜와 시간을 합쳐서 datetime 형식으로 변환 (즉시 반영이면 현재 시간)
            let reserveDateTime;
            if (immediateApply) {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                reserveDateTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } else {
                reserveDateTime = `${reserveDate} ${reserveTime}:00`;
            }
            
            // TODO: 반영예약 API 호출
            // 예시:
            // const headers = {
            //     'Content-Type': 'application/json'
            // };
            // if (csrfToken && csrfHeader) {
            //     headers[csrfHeader] = csrfToken;
            // }
            // 
            // fetch('/admin/product/reserve', {
            //     method: 'POST',
            //     headers,
            //     body: JSON.stringify({
            //         productCode,
            //         productName,
            //         status,
            //         reserveDateTime,
            //         immediateApply
            //     })
            // })
            // .then(response => response.json())
            // .then(data => {
            //     alert(immediateApply ? '즉시 반영이 완료되었습니다.' : '반영예약이 완료되었습니다.');
            //     closeReserveModal();
            //     location.reload();
            // })
            // .catch(error => {
            //     console.error(error);
            //     alert('요청을 처리하지 못했습니다. 잠시 후 다시 시도해주세요.');
            // });
            
            // 폼 데이터 설정 후 제출
            console.log('>>> 폼 제출 시작 - fundCode:', productCode, ', date:', reserveDateTime);
            document.getElementById('reserveFormFundCode').value = productCode;
            document.getElementById('reserveFormDate').value = reserveDateTime;
            
            // 폼 제출
            document.getElementById('reserveForm').submit();
        }

        // 승인요청 함수
        // 승인요청 함수
        function requestApproval(button) {
            // 비활성화된 버튼이면 동작하지 않음
            if (button.disabled) {
                return;
            }

            const fundCode = button.dataset.fundCode;
            const fundName = button.dataset.fundName;

            // 행에서 추가 정보 가져오기
            const row = button.closest('tr');
            const productCode = row.querySelector('td:first-child')?.textContent?.trim() || fundCode;
            const productName = row.querySelector('.product-name-link')?.getAttribute('title') ||
                row.querySelector('.product-name-link')?.textContent?.trim() || fundName;
            const status = row.querySelector('.status-text')?.textContent?.trim() || '';

            // revStatus 값 가져오기
            const revStatus = row.getAttribute('data-rev-status') || '';

            // 모달에 데이터 채우기
            document.getElementById('approvalProductCode').value = productCode;
            document.getElementById('approvalProductName').value = productName;

            // revStatus가 '대기'이면 '수정'으로, 아니면 기존 status(operStatus)로 표시
            document.getElementById('approvalStatus').value = (revStatus === '대기') ? '수정' : status;

            // 요청사유 필드 초기화
            document.getElementById('approvalReason').value = '';

            // 모달 표시
            document.getElementById('approvalRequestModal').classList.add('active');
        }
        // 승인요청 모달 닫기
        function closeApprovalModal() {
            document.getElementById('approvalRequestModal').classList.remove('active');
        }

        // 승인요청 폼 제출 전 유효성 검사
        document.addEventListener('DOMContentLoaded', function() {
            const approvalForm = document.getElementById('approvalRequestForm');
            if (approvalForm) {
                approvalForm.addEventListener('submit', function(e) {
                    const reason = document.getElementById('approvalReason').value;
                    
                    // 유효성 검사
                    if (!reason || reason.trim() === '') {
                        e.preventDefault();
                        alert('요청사유를 입력해주세요.');
                        return false;
                    }
                });
            }
        });

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const approvalModal = document.getElementById('approvalRequestModal');
            const reserveModal = document.getElementById('reserveProductModal');
            if (event.target === approvalModal) {
                closeApprovalModal();
            }
            if (event.target === reserveModal) {
                closeReserveModal();
            }
        }

        // 상태에 따라 버튼 표시/숨김 처리
        function updateButtonVisibility(fundCode, status) {
            const row = document.querySelector(`tr[data-product-id="${fundCode}"]`);
            if (!row) return;

            const stopBtn = row.querySelector('.action-btn.stop');
            const resumeBtn = row.querySelector('.action-btn.resume');
            const waitingBtn = row.querySelector('.action-btn.waiting');
            const approvalBtn = row.querySelector('.action-btn.approval');
            const reserveBtn = row.querySelector('.action-btn.reserve');
            const statusBadge = row.querySelector('.status-text');
            
            // revStatus 값 가져오기
            const revStatus = row.getAttribute('data-rev-status') || '';

            // 운용중단 버튼: 운용중일 때만 표시
            if (stopBtn) {
                stopBtn.style.display = (status === '운용중') ? 'inline-block' : 'none';
            }
            
            // 운용재개 버튼: 운용중단일 때만 표시
            if (resumeBtn) {
                resumeBtn.style.display = (status === '운용중단') ? 'inline-block' : 'none';
            }

            // 운용대기 버튼: 운용중/운용중단이 아닐 때 표시 (항상 비활성화)
            if (waitingBtn) {
                waitingBtn.style.display = (status !== '운용중' && status !== '운용중단') ? 'inline-block' : 'none';
            }

            // 승인요청 버튼: operStatus가 '등록', '등록대기', '수정' 또는, revStatus가 '대기'일 때 활성화
            if (approvalBtn) {
                const isOperStatusOk = (status === '등록' || status === '등록대기' || status === '수정');
                const isRevStatusOk = (revStatus === '대기');
                approvalBtn.disabled = !(isOperStatusOk || isRevStatusOk);
            }

            // 반영예약 버튼: operStatus가 '등록완료', '수정완료', '운용대기'이거나, revStatus가 '수정완료'일 때 활성화
            if (reserveBtn) {
                const isOperStatusOk = (status === '등록완료' || status === '수정완료' || status === '운용대기');
                const isRevStatusOk = (revStatus === '수정완료');
                reserveBtn.disabled = !(isOperStatusOk || isRevStatusOk);
            }

            // 수정 버튼: 운용대기, 운용중, 운용중단일 때만 활성화
            const editBtn = row.querySelector('.action-btn.edit');
            if (editBtn) {
                const isEditAllowed = (status === '운용대기' || status === '운용중' || status === '운용중단');
                // 잠금 상태 확인
                const isLocked = row.getAttribute('data-locked') === 'true';
                editBtn.disabled = !isEditAllowed || isLocked;
            }

            if (statusBadge) {
                statusBadge.textContent = status;
                statusBadge.className = 'status-text';
            }
        }

        // 상태에 따른 CSS 클래스 반환
        function getStatusClass(status) {
            const statusMap = {
                '운용중': 'active',
                '수정': 'modifying',
                '수정대기': 'modifying',
                '수정완료': 'modifying',
                '수정반려': 'modifying',
                '등록': 'pending',
                '등록대기': 'pending',
                '등록반려': 'pending',
                '운용대기': 'pending',
                '운용중단': 'stopped'
            };
            return statusMap[status] || 'pending';
        }

        // 페이지 로드 시 상태에 따라 버튼 표시/숨김 처리
        function initializeButtonVisibility() {
            const rows = document.querySelectorAll('#pendingTableBody tr');
            rows.forEach(row => {
                const statusBadge = row.querySelector('.status-text');
                if (statusBadge) {
                    const status = statusBadge.textContent.trim();
                    const fundCode = row.getAttribute('data-product-id') || 
                                    row.querySelector('.action-btn.edit')?.dataset?.fundCode;
                    
                    if (fundCode) {
                        row.setAttribute('data-product-id', fundCode);
                        updateButtonVisibility(fundCode, status);
                    }
                }
            });
            
            // 초기 로드 시 상태에 따라 버튼 활성화/비활성화 처리
            rows.forEach(row => {
                const statusBadge = row.querySelector('.status-text');
                if (statusBadge) {
                    const status = statusBadge.textContent.trim();
                    const revStatus = row.getAttribute('data-rev-status') || '';
                    const approvalBtn = row.querySelector('.action-btn.approval');
                    const reserveBtn = row.querySelector('.action-btn.reserve');
                    
                    // 승인요청 버튼: operStatus가 '등록', '등록대기', '수정'이거나, revStatus가 '대기'일 때 활성화
                    if (approvalBtn) {
                        const isOperStatusOk = (status === '등록' || status === '등록대기' || status === '수정');
                        const isRevStatusOk = (revStatus === '대기');
                        approvalBtn.disabled = !(isOperStatusOk || isRevStatusOk);
                    }
                    
                    // 반영예약 버튼: operStatus가 '등록완료', '수정완료', '운용대기'이거나, revStatus가 '수정완료'일 때 활성화
                    if (reserveBtn) {
                        const isOperStatusOk = (status === '등록완료' || status === '수정완료' || status === '운용대기');
                        const isRevStatusOk = (revStatus === '수정완료');
                        reserveBtn.disabled = !(isOperStatusOk || isRevStatusOk);
                    }
                }
            });
        }


        function viewPendingDetail(productId) {
            const product = pendingProductDetailData[productId];
            if (!product) {
                alert('상품 정보를 찾을 수 없습니다.');
                return;
            }

            // 헤더 정보 설정
            document.getElementById('fundFullName').textContent = product.productName;
            document.getElementById('fundCode').textContent = product.productCode;

        }
        
        let returnChart = null;
        let priceChart = null;
        let assetChart = null;
        
        // 벤치마크 지수 데이터 (샘플 데이터 - 날짜에 맞춤)
        const benchmarkData = {
            kospi: [8500, 8600, 8700, 8800, 8900, 9000],
            kosdaq: [2400, 2450, 2500, 2550, 2600, 2650],
            govt: [0.5, 1.2, 2.5, 3.5, 2.8, 3.2],
            corp: [0.8, 1.5, 3.0, 4.0, 3.2, 3.8]
        };
        
        // 벤치마크 지수 색상
        const benchmarkColors = {
            kospi: '#4CAF50',
            kosdaq: '#9C27B0',
            govt: '#FF69B4',
            corp: '#607D8B'
        };
        

        // 상품명 35자로 제한
        function truncateProductNames() {
            const productNameLinks = document.querySelectorAll('.product-name-link');
            productNameLinks.forEach(link => {
                let fullText = link.getAttribute('title') || link.textContent.trim();
                
                if (!link.getAttribute('title')) {
                    link.setAttribute('title', fullText);
                }
                
                if (fullText.length > 35) {
                    link.textContent = fullText.substring(0, 35) + '...';
                } else {
                    link.textContent = fullText;
                }
            });
        }

        // 회사명 6자로 제한
        function truncateCompanyNames() {
            const companyNameSpans = document.querySelectorAll('.company-name');
            companyNameSpans.forEach(span => {
                let fullText = span.getAttribute('title') || span.textContent.trim();

                if (!span.getAttribute('title')) {
                    span.setAttribute('title', fullText);
                }

                if (fullText.length > 6) {
                    span.textContent = fullText.substring(0, 6) + '...';
                } else {
                    span.textContent = fullText;
                }
            });
        }

        // 잠금 상태 업데이트 함수
        function updateLockStatus(lockStatusMap) {
            if (!lockStatusMap || Object.keys(lockStatusMap).length === 0) {
                return; // 잠금 상태 정보가 없으면 업데이트하지 않음
            }
            
            const rows = document.querySelectorAll('.product-table tbody tr');
            rows.forEach(row => {
                const fundCode = row.getAttribute('data-fund-code') || 
                                row.querySelector('.action-btn.edit')?.getAttribute('data-fund-code');
                
                if (!fundCode) return;
                
                const isLocked = lockStatusMap[fundCode] === true;
                const editBtn = row.querySelector('.action-btn.edit');
                const statusCell = row.querySelector('td:nth-child(5)'); // 최근수정일시 컬럼 (5번째)
                
                // 수정 버튼 비활성화/활성화 (운용대기, 운용중, 운용중단일 때만 활성화)
                if (editBtn) {
                    const statusBadge = row.querySelector('.status-text');
                    const status = statusBadge ? statusBadge.textContent.trim() : '';
                    const isEditAllowed = (status === '운용대기' || status === '운용중' || status === '운용중단');
                    editBtn.disabled = !isEditAllowed || isLocked;
                }
                
                // 수정상태 표시 업데이트
                if (statusCell) {
                    // 기존 수정중 표시 제거
                    const existingLockStatus = statusCell.querySelector('span[data-lock-status]');
                    if (existingLockStatus) {
                        existingLockStatus.remove();
                    }
                    
                    // 잠금 상태일 때 수정중 표시 추가
                    if (isLocked) {
                        const lockStatusSpan = document.createElement('span');
                        lockStatusSpan.setAttribute('data-lock-status', 'true');
                        lockStatusSpan.style.marginLeft = '10px';
                        lockStatusSpan.style.color = '#cd1317';
                        lockStatusSpan.style.fontWeight = '600';
                        lockStatusSpan.textContent = '[수정중]';
                        statusCell.appendChild(lockStatusSpan);
                    }
                }
            });
        }
        
        // 잠금 상태 확인 함수
        function checkLockStatus() {
            const rows = document.querySelectorAll('.product-table tbody tr');
            const fundCodes = [];
            
            rows.forEach(row => {
                const fundCode = row.getAttribute('data-fund-code') || 
                                row.querySelector('.action-btn.edit')?.getAttribute('data-fund-code');
                if (fundCode) {
                    fundCodes.push(fundCode);
                }
            });
            
            if (fundCodes.length === 0) return;
            
            const formData = new FormData();
            fundCodes.forEach(code => {
                formData.append('fundCodes', code);
            });
            
            fetch(checkLocksUrl, {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(lockStatusMap => {
                if (lockStatusMap) {
                    updateLockStatus(lockStatusMap);
                }
            })
            .catch(error => {
                console.error('잠금 상태 확인 실패:', error);
            });
        }
        
        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', function() {
            truncateProductNames();
            truncateCompanyNames();
            initializeButtonVisibility();
            
            // 초기 잠금 상태 적용 (서버에서 전달된 lockStatusMap 사용)
            const initialLockStatusMap = /*[[${lockStatusMap}]]*/ {};
            if (initialLockStatusMap && initialLockStatusMap !== null && Object.keys(initialLockStatusMap).length > 0) {
                updateLockStatus(initialLockStatusMap);
            }
            
            // 즉시 잠금 상태 확인 (뒤로가기로 돌아왔을 때를 대비)
            checkLockStatus();
            
            // 5초마다 잠금 상태 확인 (페이지가 보일 때만)
            let lockCheckInterval = setInterval(function() {
                // 페이지가 보일 때만 체크
                if (!document.hidden) {
                    checkLockStatus();
                }
            }, 10000);
            
            // 페이지가 숨겨지면 체크 중지, 보이면 다시 시작
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // 페이지가 숨겨지면 체크 중지
                    if (lockCheckInterval) {
                        clearInterval(lockCheckInterval);
                        lockCheckInterval = null;
                    }
                } else {
                    // 페이지가 보이면 즉시 체크하고 다시 시작
                    checkLockStatus();
                    if (!lockCheckInterval) {
                        lockCheckInterval = setInterval(function() {
                            if (!document.hidden) {
                                checkLockStatus();
                            }
                        }, 5000);
                    }
                }
            });
        });
        
        // 뒤로가기로 돌아왔을 때 즉시 잠금 상태 확인
        window.addEventListener('pageshow', function(e) {
            // 뒤로가기로 돌아왔을 때 (persisted가 true)
            if (e.persisted) {
                console.log('뒤로가기로 돌아옴 - 잠금 상태 즉시 확인');
                setTimeout(function() {
                    checkLockStatus();
                }, 100);
            }
        });
        /*]]>*/
    </script>
    <!-- 사이드바 스크립트 -->
    <div th:replace="~{admin/_sidebar :: sidebar-script}"></div>
</body>
</html>


<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í€ë“œ ë“±ë¡ - ì€í–‰ í€ë“œ ìƒí’ˆ ê´€ë¦¬ì</title>
    <link rel="stylesheet" th:href="@{/css/admin/admin_styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin/adminproduct.css}">
</head>
<body>
    <!-- ì‚¬ì´ë“œë°” Fragment -->
    <div th:replace="~{admin/_sidebar :: sidebar('product-register')}"></div>

    <div class="main-content">
        <!-- í—¤ë” Fragment -->
        <div th:replace="~{admin/_header :: header}"></div>
        <div class="main-content-body">
            <div class="container">
                <!-- í˜ì´ì§€ í—¤ë” -->
                <header class="page-header">
                    <h1>í€ë“œ ì‹ ê·œ ë“±ë¡</h1>
                </header>

                <!-- í€ë“œ ê²€ìƒ‰ -->
                <!-- í€ë“œ ê²€ìƒ‰ -->
                <form th:action="@{/admin/product/register}" method="get" class="product-classification-bar">
                    <div class="classification-label">í€ë“œ ê²€ìƒ‰</div>
                    <div class="classification-inputs">
                        <select class="form-select search-select-small"
                                id="searchType"
                                name="searchType"
                                th:value="${pageRequestDTO != null} ? ${pageRequestDTO.searchType} : 'code'">
                            <option value="code"
                                    th:selected="${pageRequestDTO != null and pageRequestDTO.searchType == 'code'}">í€ë“œì½”ë“œ</option>
                            <option value="name"
                                    th:selected="${pageRequestDTO != null and pageRequestDTO.searchType == 'name'}">í€ë“œëª…</option>
                        </select>

                        <div style="position: relative; width: 100%;">
                            <input type="text"
                                   class="form-input search-input-large"
                                   id="searchKeyword"
                                   name="keyword"
                                   placeholder="ì…ë ¥í•˜ì„¸ìš”"
                                   autocomplete="off"
                                   th:value="${pageRequestDTO != null} ? ${pageRequestDTO.keyword} : ''">

                            <!-- ìë™ì™„ì„± ë¦¬ìŠ¤íŠ¸ ë°•ìŠ¤ -->
                            <div id="searchSuggestions"
                                 style="position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #ddd; border-top:none; z-index:1000; display:none; max-height:200px; overflow-y:auto;">
                            </div>
                        </div>

                        <button class="btn btn-search-inline" type="submit">ê²€ìƒ‰</button>
                    </div>
                </form>

                <!-- í•„ìˆ˜ì •ë³´ -->
                <div class="form-section">
                    <h2 class="section-title">í•„ìˆ˜ì •ë³´</h2>
                    <div class="form-table">
                        <div class="form-row">
                            <div class="form-label">ìƒí’ˆëª…</div>
                            <div class="form-input-wrapper">
                                <input type="text" class="form-input"
                                       id="productName"
                                       placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                                       th:value="${fund != null} ? ${fund.fundName} : ''">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-label">ìƒí’ˆì½”ë“œ</div>
                            <div class="form-input-wrapper">
                                <input type="text" class="form-input"
                                       id="productCode"
                                       placeholder="ìƒí’ˆì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                       th:value="${fund != null} ? ${fund.fundCode} : ''">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-label">í€ë“œìœ í˜•</div>
                            <div class="form-input-wrapper">
                                <input type="text" class="form-input"
                                       placeholder="í€ë“œìœ í˜•"
                                       th:value="${fund != null} ? ${fund.fundTypeName} : ''" readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-label">íˆ¬ìë“±ê¸‰</div>
                            <div class="form-input-wrapper">
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="investmentGrade" value="1"
                                               th:checked="${fund != null and fund.investGrade == '1'}"> 1ë“±ê¸‰
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="investmentGrade" value="2"
                                               th:checked="${fund != null and fund.investGrade == '2'}"> 2ë“±ê¸‰
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="investmentGrade" value="3"
                                               th:checked="${fund != null and fund.investGrade == '3'}"> 3ë“±ê¸‰
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="investmentGrade" value="4"
                                               th:checked="${fund != null and fund.investGrade == '4'}"> 4ë“±ê¸‰
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="investmentGrade" value="5"
                                               th:checked="${fund != null and fund.investGrade == '5'}"> 5ë“±ê¸‰
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!--<div class="form-row">
                            <div class="form-label">ë“±ë¡ì¼</div>
                            <div class="form-input-wrapper">
                                <input type="date" class="form-input" id="registrationDate">
                            </div>
                        </div>-->
                        <div class="form-row">
                            <div class="form-label">ìš´ìš©ì‚¬</div>
                            <div class="form-input-wrapper">
                                <input type="text"
                                       class="form-input"
                                       id="managementCompany"
                                       placeholder="ìš´ìš©ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                       th:value="${fund != null} ? ${fund.assetManagerName} : ''">
                            </div>
                        </div>


                        <div class="form-row">
                            <div class="form-label">ê°€ì…ëŒ€ìƒ</div>
                            <div class="form-input-wrapper">
                                <input type="text" class="form-input" id="subscriptionTarget" placeholder="ê°€ì…ëŒ€ìƒì„ ì…ë ¥í•˜ì„¸ìš”">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-label">ìƒí’ˆíŠ¹ì§•</div>
                            <div class="form-input-wrapper">
                                <textarea class="form-textarea" id="productFeatures" rows="5" placeholder="ìƒí’ˆíŠ¹ì§•ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- ë¬¸ì„œê´€ë¦¬ -->
                <div class="form-section">
                    <h2 class="section-title">ë¬¸ì„œê´€ë¦¬</h2>
                    <div class="form-table">
                        <div class="form-row">
                            <div class="form-label">ì•½ê´€</div>
                            <div class="form-input-wrapper">
                                <!-- ìƒˆ íŒŒì¼ ì—…ë¡œë“œ -->
                                <div class="file-upload" id="termsDocUpload">
                                    <input type="file" id="termsDoc" accept=".pdf,.doc,.docx" style="display: none;">
                                    <button type="button" class="btn btn-secondary" id="termsDocButton" onclick="document.getElementById('termsDoc').click()">íŒŒì¼ ì„ íƒ</button>
                                </div>
                                <div id="termsDocList" class="file-list"></div>
                                <small class="file-help">PDF, DOC, DOCX íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-label">íˆ¬ìì„¤ëª…ì„œ</div>
                            <div class="form-input-wrapper">
                                <!-- ìƒˆ íŒŒì¼ ì—…ë¡œë“œ -->
                                <div class="file-upload" id="investmentDocUpload">
                                    <input type="file" id="investmentDoc" accept=".pdf,.doc,.docx" style="display: none;">
                                    <button type="button" class="btn btn-secondary" id="investmentDocButton" onclick="document.getElementById('investmentDoc').click()">íŒŒì¼ ì„ íƒ</button>
                                </div>
                                <div id="investmentDocList" class="file-list"></div>
                                <small class="file-help">PDF, DOC, DOCX íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-label">ê°„ì´ íˆ¬ì ì„¤ëª…ì„œ</div>
                            <div class="form-input-wrapper">
                                <!-- ìƒˆ íŒŒì¼ ì—…ë¡œë“œ -->
                                <div class="file-upload" id="simpleInvestmentDocUpload">
                                    <input type="file" id="simpleInvestmentDoc" accept=".pdf,.doc,.docx" style="display: none;">
                                    <button type="button" class="btn btn-secondary" id="simpleInvestmentDocButton" onclick="document.getElementById('simpleInvestmentDoc').click()">íŒŒì¼ ì„ íƒ</button>
                                </div>
                                <div id="simpleInvestmentDocList" class="file-list"></div>
                                <small class="file-help">PDF, DOC, DOCX íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- í¼ ì•¡ì…˜ ë²„íŠ¼ -->
                <div class="form-actions">
                    <button type="button" class="btn btn-red">ë“±ë¡</button>
                    <a th:href="@{/admin/product}" class="btn btn-secondary">ì·¨ì†Œ</a>
                </div>
                <!-- í‘¸í„° ì˜ì—­ -->
                <footer class="admin-footer"></footer>
            </div>
        </div>
    </div>
    <!-- ì‚¬ì´ë“œë°” ìŠ¤í¬ë¦½íŠ¸ -->
    <div th:replace="~{admin/_sidebar :: sidebar-script}"></div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function() {

            // ==========================
            // 1. íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨
            // ==========================
            const termsInput = document.getElementById('termsDoc');
            const investmentInput = document.getElementById('investmentDoc');
            const simpleInvestmentInput = document.getElementById('simpleInvestmentDoc');

            if (termsInput) {
                termsInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        addFileToList('termsDocList', file, 'termsDoc');
                        document.getElementById('termsDocUpload').style.display = 'none';
                    }
                });
            }

            if (investmentInput) {
                investmentInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        addFileToList('investmentDocList', file, 'investmentDoc');
                        document.getElementById('investmentDocUpload').style.display = 'none';
                    }
                });
            }

            if (simpleInvestmentInput) {
                simpleInvestmentInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        addFileToList('simpleInvestmentDocList', file, 'simpleInvestmentDoc');
                        document.getElementById('simpleInvestmentDocUpload').style.display = 'none';
                    }
                });
            }

            function addFileToList(listId, file, inputId) {
                const fileList = document.getElementById(listId);
                if (!fileList) return;

                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
            <span class="file-item-name">${file.name}</span>
            <div class="file-actions">
                <a href="#" class="file-download" title="ë‹¤ìš´ë¡œë“œ">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="download-icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                </a>
                <button type="button" class="file-item-remove" onclick="removeFile(this, '${listId}', '${inputId}')" title="ì‚­ì œ">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="delete-icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        `;
                fileList.innerHTML = '';
                fileList.appendChild(fileItem);
            }

            window.removeFile = function(button, listId, inputId) {
                const fileList = document.getElementById(listId);
                if (fileList) {
                    fileList.innerHTML = '';
                }

                const input = document.getElementById(inputId);
                if (input) {
                    input.value = '';
                }

                if (inputId === 'termsDoc') {
                    document.getElementById('termsDocUpload').style.display = 'flex';
                } else if (inputId === 'investmentDoc') {
                    document.getElementById('investmentDocUpload').style.display = 'flex';
                } else if (inputId === 'simpleInvestmentDoc') {
                    document.getElementById('simpleInvestmentDocUpload').style.display = 'flex';
                }
            };

            // ==========================
            // 2. í€ë“œ ìë™ì™„ì„± (ì½”ë“œ/ì´ë¦„ ëª¨ë‘ ì§€ì›)
            // ==========================
            const searchTypeSelect = document.getElementById('searchType');
            const searchInput = document.getElementById('searchKeyword');
            const suggestionBox = document.getElementById('searchSuggestions');

            if (!searchTypeSelect || !searchInput || !suggestionBox) {
                console.error('ìë™ì™„ì„±ì— í•„ìš”í•œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let suggestionTimer = null;
            let activeIndex = -1;

            function clearSuggestions() {
                suggestionBox.style.display = 'none';
                suggestionBox.innerHTML = '';
                activeIndex = -1;
            }

            function applyActiveState(items) {
                items.forEach((item, idx) => {
                    if (idx === activeIndex) {
                        item.style.backgroundColor = '#f0f4ff';
                        item.style.fontWeight = '600';
                    } else {
                        item.style.backgroundColor = '#ffffff';
                        item.style.fontWeight = 'normal';
                    }
                });
            }

            function selectSuggestion(item) {
                const fundCode = item.getAttribute('data-fund-code');
                const fundName = item.getAttribute('data-fund-name');
                const currentType = searchTypeSelect.value; // 'code' or 'name'

                if (currentType === 'code') {
                    searchInput.value = fundCode;
                } else {
                    searchInput.value = fundName;
                }

                clearSuggestions();
                // í˜„ì¬ searchType + keyword ê·¸ëŒ€ë¡œ ê°€ì§€ê³  /admin/product/register GET í˜¸ì¶œ
                searchInput.form.submit();
            }

            // ğŸ”— ì»¨í…ìŠ¤íŠ¸ ê²½ë¡œê¹Œì§€ í¬í•¨ëœ ì‹¤ì œ URL ìƒì„± (ì˜ˆ: /bnk/admin/product/autocomplete)
            const autocompleteUrl = /*[[@{/admin/product/autocomplete}]]*/ '';

            // ì…ë ¥ ì‹œ ìë™ì™„ì„± í˜¸ì¶œ
            searchInput.addEventListener('input', function() {
                const keyword = this.value.trim();
                const searchType = searchTypeSelect.value;

                if (keyword.length < 1) {
                    clearSuggestions();
                    return;
                }

                if (suggestionTimer) {
                    clearTimeout(suggestionTimer);
                }

                suggestionTimer = setTimeout(() => {
                    fetch(`${autocompleteUrl}?searchType=${encodeURIComponent(searchType)}&keyword=${encodeURIComponent(keyword)}`)
                        .then(res => {
                            if (!res.ok) {
                                throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
                            }
                            return res.json();
                        })
                        .then(data => {
                            console.log('ìë™ì™„ì„± ì‘ë‹µ:', data);

                            if (!data || data.length === 0) {
                                clearSuggestions();
                                return;
                            }

                            suggestionBox.innerHTML = '';

                            data.forEach((item, idx) => {
                                const div = document.createElement('div');
                                div.className = 'suggestion-item';
                                div.style.padding = '10px 12px';
                                div.style.cursor = 'pointer';
                                div.style.fontSize = '14px';
                                div.style.borderBottom = '1px solid #eee';
                                div.style.transition = 'background-color 0.2s';

                                div.textContent = `${item.fundCode} - ${item.fundName}`;

                                div.setAttribute('data-fund-code', item.fundCode);
                                div.setAttribute('data-fund-name', item.fundName);

                                div.addEventListener('mouseenter', () => {
                                    activeIndex = idx;
                                    applyActiveState([...suggestionBox.children]);
                                });

                                div.addEventListener('mouseleave', () => {
                                    activeIndex = -1;
                                    applyActiveState([...suggestionBox.children]);
                                });

                                div.addEventListener('click', () => {
                                    selectSuggestion(div);
                                });

                                suggestionBox.appendChild(div);
                            });

                            suggestionBox.style.display = 'block';
                            activeIndex = -1;
                        })
                        .catch(err => {
                            console.error('ìë™ì™„ì„± ì—ëŸ¬:', err);
                            clearSuggestions();
                        });
                }, 200);
            });

            // â†‘ / â†“ / Enter / ESC ì²˜ë¦¬
            searchInput.addEventListener('keydown', function(e) {
                const items = [...suggestionBox.children];

                if (items.length === 0 || suggestionBox.style.display === 'none') {
                    return;
                }

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    activeIndex = (activeIndex + 1) % items.length;
                    applyActiveState(items);
                    items[activeIndex].scrollIntoView({ block: 'nearest' });
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    activeIndex = (activeIndex - 1 + items.length) % items.length;
                    applyActiveState(items);
                    items[activeIndex].scrollIntoView({ block: 'nearest' });
                } else if (e.key === 'Enter') {
                    if (activeIndex >= 0 && activeIndex < items.length) {
                        e.preventDefault();
                        selectSuggestion(items[activeIndex]);
                    }
                } else if (e.key === 'Escape') {
                    clearSuggestions();
                }
            });

            // ë°”ê¹¥ í´ë¦­í•˜ë©´ ìë™ì™„ì„± ë‹«ê¸°
            document.addEventListener('click', function(e) {
                if (!suggestionBox.contains(e.target) &&
                    e.target !== searchInput &&
                    e.target !== searchTypeSelect) {
                    clearSuggestions();
                }
            });

        });
        /*]]>*/
    </script>

</body>
</html>

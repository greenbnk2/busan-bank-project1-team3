<div th:replace="~{member/_head.html}"></div>
<div class="login-container">
    <!-- 탭 메뉴 -->
    <div class="tab-menu">
        <p>홈페이지 회원</p>
    </div>
    <!-- 홈페이지 회원 -->
    <div id="homepage" class="tab-content center-content">
        <form class="login-form" th:action="@{/login}" method="post">
            <input type="text" name="userid" placeholder="아이디를 입력해주세요" required>

            <input type="password" name="userpw" id="passwordInput" placeholder="비밀번호를 입력해주세요" required>

            <label><input type="checkbox" id="useMouseInput"> 마우스로 입력</label>

            <div id="virtualKeyboardBox">
                <div class="simple-keyboard"></div>
            </div>

            <div th:if="${param.error}" class="error-message" style="color: #c6281f; font-size: 14px; margin-bottom: 10px;">
                아이디 또는 비밀번호를 확인해주세요.
            </div>

            <button type="submit" class="btn-red">로그인</button>

            <div class="link-group">
                <a th:href="@{/find-id}">아이디조회</a> |
                <a th:href="@{/find-password}">비밀번호변경</a> |
                <a th:href="@{/member/type}">회원가입</a>
            </div>
        </form>
        <div class="info">
            홈페이지회원 로그인은 일부 서비스에 한하여 이용하실 수 있습니다.
        </div>
    </div>
</div>
<div th:replace="~{member/_tail.html}"></div>

<script>
    let myKeyboard; // 키보드 객체 저장 변수

    document.addEventListener('DOMContentLoaded', function() {
        const checkbox = document.getElementById('useMouseInput');
        const keyboardBox = document.getElementById('virtualKeyboardBox');
        const inputElement = document.getElementById('passwordInput');

        // 1. 체크박스 변경 감지
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                keyboardBox.style.display = 'block';
                initKeyboard();
            } else {
                keyboardBox.style.display = 'none';
            }
        });

        // 2. 키보드 초기화 및 랜덤 배치 함수
        function initKeyboard() {
            // 숫자 0~9를 배열로 만들어서 무작위로 섞음 (Shuffle)
            const numbers = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'];
            shuffleArray(numbers);
            const numRow = numbers.join(" "); // 예: "5 0 2 8 1 9 3 7 4 6"

            // 키보드 옵션 설정
            const keyboardOptions = {
                onChange: input => onChange(input),
                onKeyPress: button => onKeyPress(button),
                layoutName: "default", // 기본 레이아웃 시작
                layout: {
                    // 1) 기본 영문 레이아웃 (특수문자 버튼 추가됨)
                    default: [
                        numRow + " {bksp}",
                        "q w e r t y u i o p",
                        "a s d f g h j k l",
                        "{shift} z x c v b n m {special}", // {special} 버튼 추가
                        "{space}"
                    ],
                    // 2) Shift(대문자) 레이아웃
                    shift: [
                        numRow + " {bksp}",
                        "Q W E R T Y U I O P",
                        "A S D F G H J K L",
                        "{shift} Z X C V B N M {special}",
                        "{space}"
                    ],
                    // 3) 특수문자 레이아웃 (새로 추가됨)
                    special: [
                        numRow + " {bksp}", // 랜덤 숫자는 그대로 유지
                        "! @ # $ % ^ & * ( )",
                        "- _ = + [ ] { } \\ |",
                        "{normal} ; : ' \" , . < > / ? {normal}", // {normal}로 복귀
                        "{space}"
                    ]
                },
                display: {
                    "{bksp}": "⌫",
                    "{shift}": "⇧",
                    "{space}": "SPACE",
                    "{special}": "!#$", // 특수문자 버튼 라벨
                    "{normal}": "ABC"   // 복귀 버튼 라벨
                },
                buttonTheme: [
                    {
                        class: "hg-button-numpad",
                        buttons: numRow
                    },
                    {
                        class: "hg-button-function", // 기능키 색상 구분(선택)
                        buttons: "{shift} {special} {normal} {bksp}"
                    }
                ]
            };

            if(myKeyboard) myKeyboard.destroy();
            myKeyboard = new SimpleKeyboard.default(keyboardOptions);
        }

        // 3. 입력 처리
        function onChange(input) {
            inputElement.value = input;
        }

        // 4. 키 버튼 클릭 처리 (특수문자/한영 전환 로직 추가)
        function onKeyPress(button) {
            // (1) Shift 키 처리
            if (button === "{shift}") {
                let currentLayout = myKeyboard.options.layoutName;
                let shiftToggle = currentLayout === "default" ? "shift" : "default";

                // 특수문자 화면에서는 Shift 작동 안 하게 하거나, 필요 시 로직 추가
                if(currentLayout === "special") return;

                myKeyboard.setOptions({
                    layoutName: shiftToggle
                });
            }
            // (2) 특수문자 화면으로 전환
            else if (button === "{special}") {
                myKeyboard.setOptions({
                    layoutName: "special"
                });
            }
            // (3) 일반 영문 화면으로 복귀
            else if (button === "{normal}") {
                myKeyboard.setOptions({
                    layoutName: "default"
                });
            }
        }

        // 5. 배열 무작위 섞기
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // 물리 키보드 동기화
        inputElement.addEventListener("input", event => {
            if(myKeyboard) {
                myKeyboard.setInput(event.target.value);
            }
        });
    });
</script>
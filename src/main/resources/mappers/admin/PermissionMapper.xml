<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.bnk.bnk_project.mapper.admin.PermissionMapper">

    <!-- 회원 ResultMap -->
    <resultMap id="BnkUserResultMap" type="kr.co.bnk.bnk_project.dto.admin.UserSearchDTO">
        <id     property="custNo"    column="CUST_NO"/>
        <result property="custId"    column="CUST_ID"/>
        <result property="custName"  column="CUST_NAME"/>
        <result property="custHp"    column="CUST_HP"/>
        <result property="custEmail" column="CUST_EMAIL"/>
        <result property="statusCode" column="STATUS_CODE"/>
        <result property="joinDate"  column="JOIN_DATE"/>
    </resultMap>

    <!-- 검색 where 절 -->
    <sql id="userSearchWhere">
        <where>

            <if test="pageRequestDTO.keyword != null
                  and pageRequestDTO.keyword != ''">
                <choose>
                    <!-- 아이디 -->
                    <when test="pageRequestDTO.searchType == 'custId'">
                        AND bu.CUST_ID LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>

                    <!-- 이름 -->
                    <when test="pageRequestDTO.searchType == 'custName'">
                        AND bu.CUST_NAME LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>


                    <!-- 기본: 아이디 + 이름 + 이메일 통합 검색 -->
                    <otherwise>
                        AND (
                        bu.CUST_ID    LIKE '%' || #{pageRequestDTO.keyword} || '%'
                        OR bu.CUST_NAME  LIKE '%' || #{pageRequestDTO.keyword} || '%'
                        )
                    </otherwise>
                </choose>
            </if>

        </where>
    </sql>


    <!-- 검색 목록 -->
    <select id="selectUserSearchList"
            parameterType="kr.co.bnk.bnk_project.dto.PageRequestDTO"
            resultMap="BnkUserResultMap">

        SELECT
        bu.CUST_NO,
        bu.CUST_ID,
        bu.CUST_NAME,
        bu.CUST_HP,
        bu.CUST_EMAIL,
        bu.STATUS_CODE,
        bu.JOIN_DATE
        FROM ADMIN.BNK_USER bu

        <include refid="userSearchWhere"/>

        ORDER BY bu.CUST_NO DESC
        OFFSET #{pageRequestDTO.startRow} ROWS
        FETCH NEXT #{pageRequestDTO.size} ROWS ONLY
    </select>

    <!-- 검색 총 개수 -->
    <select id="selectUserSearchTotal"
            parameterType="kr.co.bnk.bnk_project.dto.PageRequestDTO"
            resultType="int">

        SELECT COUNT(*)
        FROM ADMIN.BNK_USER bu
        <include refid="userSearchWhere"/>

    </select>


    <!-- 관리자 ResultMap -->
    <resultMap id="AdminListResultMap"
               type="kr.co.bnk.bnk_project.dto.admin.AdminListDTO">
        <id     property="adminNo"    column="ADMIN_NO"/>
        <result property="adminId"    column="ADMIN_ID"/>
        <result property="adminName"  column="ADMIN_NAME"/>
        <result property="role"       column="ROLE"/>

        <result property="custHp"     column="CUST_HP"/>
        <result property="custEmail"  column="CUST_EMAIL"/>
        <result property="joinDate"   column="JOIN_DATE"/>
    </resultMap>


    <!-- 관리자 검색 where 절 -->
    <sql id="adminSearchWhere">
        <where>
            <if test="pageRequestDTO.keyword != null and pageRequestDTO.keyword != ''">
                <choose>

                    <!-- 관리자 아이디로 검색 -->
                    <when test="pageRequestDTO.searchType == 'adminId'">
                        AND ba.ADMIN_ID LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>

                    <!-- 관리자 이름으로 검색 -->
                    <when test="pageRequestDTO.searchType == 'adminName'">
                        AND ba.ADMIN_NAME LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>

                    <!-- 기본: 아이디 + 이름 통합검색 -->
                    <otherwise>
                        AND (
                        ba.ADMIN_ID   LIKE '%' || #{pageRequestDTO.keyword} || '%' OR
                        ba.ADMIN_NAME LIKE '%' || #{pageRequestDTO.keyword} || '%'
                        )
                    </otherwise>

                </choose>
            </if>
        </where>
    </sql>

    <select id="selectAdminList"
            parameterType="kr.co.bnk.bnk_project.dto.PageRequestDTO"
            resultMap="AdminListResultMap">

        SELECT
        ba.ADMIN_NO,
        ba.ADMIN_ID,
        ba.ADMIN_NAME,
        ba.ROLE,
        bu.CUST_HP,
        bu.CUST_EMAIL,
        bu.JOIN_DATE
        FROM ADMIN.BNK_ADMIN ba
        LEFT JOIN ADMIN.BNK_USER bu
        ON ba.ADMIN_ID = bu.CUST_ID

        <include refid="adminSearchWhere"/>

        OFFSET #{pageRequestDTO.startRow} ROWS
        FETCH NEXT #{pageRequestDTO.size} ROWS ONLY
    </select>

    <select id="selectAdminTotal"
            parameterType="kr.co.bnk.bnk_project.dto.PageRequestDTO"
            resultType="int">

        SELECT COUNT(*)
        FROM ADMIN.BNK_ADMIN ba
        LEFT JOIN ADMIN.BNK_USER bu
        ON ba.ADMIN_ID = bu.CUST_ID

        <include refid="adminSearchWhere"/>

    </select>

    <!-- 회원을 관리자 테이블에 추가 -->
    <insert id="insertAdminFromUser" parameterType="map">
        INSERT INTO ADMIN.BNK_ADMIN
            (ADMIN_NO, ADMIN_ID, PASSWORD, ADMIN_NAME, ROLE)
        SELECT
            SEQ_BNK_ADMIN.NEXTVAL,     -- 관리자 번호 (시퀀스 가정)
            bu.CUST_ID,                -- 회원 ID → 관리자 ID
            bu.PASSWORD,               -- 회원 비밀번호 그대로 사용 (이미 암호화 되어있다고 가정)
            bu.CUST_NAME,              -- 회원 이름
            #{role}                    -- 선택한 권한(SAD/ADM/CS)
        FROM ADMIN.BNK_USER bu
        WHERE bu.CUST_NO = #{custNo}
    </insert>



    <!-- 관리자 권한 수정 -->
    <update id="updateAdminRole">
        UPDATE ADMIN.BNK_ADMIN
        SET ROLE = #{role}
        WHERE ADMIN_NO = #{adminNo}
    </update>

</mapper>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.bnk.bnk_project.mapper.admin.AdminFundMapper">

    <!-- FUND_MASTER + ASSET_MANAGEMENT_COMPANY 조인 결과 매핑 -->
    <resultMap id="FundMasterResultMap"
               type="kr.co.bnk.bnk_project.dto.admin.AdminFundMasterDTO">
        <result property="fundCode"        column="FUND_CODE"/>
        <result property="fundShortCode"   column="FUND_SHORT_CODE"/>
        <result property="fundName"        column="FUND_NAME"/>
        <result property="fundType"        column="FUND_TYPE"/>
        <result property="investGrade"     column="INVEST_GRADE"/>
        <result property="fundFeature"     column="FUND_FEATURE"/>
        <result property="operStatus"      column="OPER_STATUS"/>
        <result property="updateStat"      column="UPDATE_STAT"/>

        <result property="notice1"      column="NOTICE_1"/>
        <result property="notice2"      column="NOTICE_2"/>

        <result property="assetManagerId"   column="ASSET_MANAGER_ID"/>
        <result property="assetManagerName" column="OPERATOR_NAME"/>

        <result property="fundTypeName"     column="FUND_TYPE_NAME"/>

        <result property="operStartAt" column="OPER_START_AT"/>
        <result property="reserveYn"   column="RESERVE_YN"/>
    </resultMap>

    <!--
        펀드 단일 조회
     -->
    <select id="selectPendingFund"
            parameterType="kr.co.bnk.bnk_project.dto.PageRequestDTO"
            resultMap="FundMasterResultMap">

        SELECT
        fm.FUND_CODE,
        fm.FUND_SHORT_CODE,
        fm.FUND_NAME,
        fm.FUND_TYPE,
        fm.INVEST_GRADE,
        fm.FUND_FEATURE,
        fm.OPER_STATUS,
        fm.ASSET_MANAGER_ID,
        am.OPERATOR_NAME,
        fc.CATEGORY_NAME AS FUND_TYPE_NAME,
        fm.NOTICE_1,
        fm.NOTICE_2
        FROM BNK.FUND_MASTER fm
        LEFT JOIN BNK.ASSET_MANAGEMENT_COMPANY am
        ON fm.ASSET_MANAGER_ID = am.OPERATOR_ID
        LEFT JOIN BNK.FUND_CATEGORY fc
        ON fm.FUND_TYPE = fc.CATEGORY_CODE
        WHERE 1 = 1
        <choose>
            <!-- 펀드코드 검색: 정확히 일치 (대소문자 무시) -->
            <when test="searchType == null or searchType == '' or searchType == 'code'">
                AND UPPER(fm.FUND_CODE) = UPPER(#{keyword})
            </when>

            <!-- 펀드명 검색: 정확히 일치 (LIKE 아님, 대소문자 무시) -->
            <when test="searchType == 'name'">
                AND UPPER(fm.FUND_NAME) = UPPER(#{keyword})
            </when>
        </choose>
    </select>


    <!-- AdminFundMapper.xml -->

    <!-- 자동완성 -->
    <select id="selectFundSuggestions"
            parameterType="map"
            resultMap="FundMasterResultMap">

        SELECT *
        FROM (
        SELECT
        fm.FUND_CODE,
        fm.FUND_SHORT_CODE,
        fm.FUND_NAME,
        fm.FUND_TYPE,
        fm.INVEST_GRADE,
        fm.FUND_FEATURE,
        fm.OPER_STATUS,
        fm.ASSET_MANAGER_ID,
        am.OPERATOR_NAME,
        fc.CATEGORY_NAME AS FUND_TYPE_NAME,
        fm.NOTICE_1,
        fm.NOTICE_2
        FROM BNK.FUND_MASTER fm
        LEFT JOIN BNK.ASSET_MANAGEMENT_COMPANY am
        ON fm.ASSET_MANAGER_ID = am.OPERATOR_ID
        LEFT JOIN BNK.FUND_CATEGORY fc
        ON fm.FUND_TYPE = fc.CATEGORY_CODE
        WHERE 1 = 1
          and oper_status = '대기'

        <choose>
            <!-- 코드 기준 자동완성 (대소문자 무시) -->
            <when test="searchType == 'code'">
                AND UPPER(fm.FUND_CODE) LIKE UPPER(#{keyword}) || '%'
            </when>

            <!-- 이름 기준 자동완성 (대소문자 무시) -->
            <when test="searchType == 'name'">
                AND UPPER(fm.FUND_NAME) LIKE '%' || UPPER(#{keyword}) || '%'
            </when>

            <!-- 혹시 몰라서 기본값은 코드로 -->
            <otherwise>
                AND UPPER(fm.FUND_CODE) LIKE UPPER(#{keyword}) || '%'
            </otherwise>
        </choose>

        ORDER BY fm.FUND_CODE
        )
        WHERE ROWNUM &lt;= 5
    </select>

    <update id="updateFundForRegister"
            parameterType="kr.co.bnk.bnk_project.dto.admin.AdminFundMasterDTO">

        UPDATE BNK.FUND_MASTER
        SET
            FUND_NAME     = #{fundName},
            INVEST_GRADE  = #{investGrade},
            FUND_FEATURE  = #{fundFeature},
            NOTICE_1      =#{notice1},
            NOTICE_2      =#{notice2},
            OPER_STATUS   = '등록',            -- 상태 변경
            LAST_UPD_DATE = SYSDATE
        WHERE FUND_CODE = #{fundCode}
    </update>



    <!-- =============================================================== -->



    <!-- 수정 -->
    <select id="selectPendingFundEdit"
            resultMap="FundMasterResultMap">

        SELECT
        fm.FUND_CODE,
        fm.FUND_SHORT_CODE,
        fm.FUND_NAME,
        fm.FUND_TYPE,
        fm.INVEST_GRADE,
        fm.FUND_FEATURE,
        fm.OPER_STATUS,
        NVL(rev.REV_STATUS, '') AS UPDATE_STAT,
        fm.ASSET_MANAGER_ID,
        am.OPERATOR_NAME,
        fc.CATEGORY_NAME AS FUND_TYPE_NAME,
        fm.NOTICE_1,
        fm.NOTICE_2
        FROM BNK.FUND_MASTER fm
        LEFT JOIN BNK.ASSET_MANAGEMENT_COMPANY am
        ON fm.ASSET_MANAGER_ID = am.OPERATOR_ID
        LEFT JOIN BNK.FUND_CATEGORY fc
        ON fm.FUND_TYPE = fc.CATEGORY_CODE
        LEFT JOIN (
            SELECT FUND_CODE, REV_STATUS, ROW_NUMBER() OVER (PARTITION BY FUND_CODE ORDER BY CREATED_AT DESC) AS rn
            FROM BNK.FUND_MASTER_REVISION
            WHERE REV_STATUS IN ('대기', '승인완료')
        ) rev ON fm.FUND_CODE = rev.FUND_CODE AND rev.rn = 1
        WHERE fm.FUND_CODE = #{fundCode}
    </select>

    <update id="updateFundForEdit"
            parameterType="kr.co.bnk.bnk_project.dto.admin.AdminFundMasterDTO">

        UPDATE BNK.FUND_MASTER
        SET
            INVEST_GRADE  = #{investGrade,jdbcType=VARCHAR},
            FUND_FEATURE  = #{fundFeature,jdbcType=CLOB},
            NOTICE_1      = #{notice1,jdbcType=CLOB},
            NOTICE_2      = #{notice2,jdbcType=CLOB},
            LAST_UPD_DATE = SYSDATE
        WHERE FUND_CODE = #{fundCode,jdbcType=VARCHAR}
    </update>


    <update id="stopFund"
            parameterType="kr.co.bnk.bnk_project.dto.admin.AdminFundMasterDTO">

        UPDATE BNK.FUND_MASTER
        SET
            OPER_STATUS   = '운용중단',            -- 상태 변경
            LAST_UPD_DATE = SYSDATE
        WHERE FUND_CODE = #{fundCode}
    </update>

    <update id="resumeFund"
            parameterType="kr.co.bnk.bnk_project.dto.admin.AdminFundMasterDTO">

        UPDATE BNK.FUND_MASTER
        SET
            OPER_STATUS   = '운용중',            -- 상태 변경
            LAST_UPD_DATE = SYSDATE
        WHERE FUND_CODE = #{fundCode}
    </update>



    <!--==============================================================================================================-->
    <!-- 공통 WHERE 절 -->
    <sql id="productWhere">
        <where>

            <!-- 1) 검색조건(searchType + keyword) -->
            <if test="pageRequestDTO.searchType != null
                      and pageRequestDTO.keyword != null
                      and pageRequestDTO.keyword != ''">

                <choose>
                    <when test="pageRequestDTO.searchType == 'name'">
                        AND fm.fund_name LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>

                    <when test="pageRequestDTO.searchType == 'code'">
                        AND fm.fund_code = #{pageRequestDTO.keyword}
                    </when>

                    <when test="pageRequestDTO.searchType == 'type'">
                        AND fm.fund_type LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                </choose>
            </if>

            <!-- 2) 펀드분류 -->
            <if test="pageRequestDTO.category != null and pageRequestDTO.category != ''">
                AND fm.fund_type = #{pageRequestDTO.category}
            </if>

            <!-- 3) 상태 -->
            <if test="pageRequestDTO.status != null and pageRequestDTO.status != ''">
                <choose>
                    <!-- updateStat 관련 상태는 REVISION 테이블의 REV_STATUS로 검색 -->
                    <when test="pageRequestDTO.status == '수정' or 
                                pageRequestDTO.status == '수정대기' or 
                                pageRequestDTO.status == '수정완료' or 
                                pageRequestDTO.status == '수정반려'">
                        AND EXISTS (
                            SELECT 1 FROM BNK.FUND_MASTER_REVISION rev
                            WHERE rev.FUND_CODE = fm.fund_code
                              AND rev.REV_STATUS = #{pageRequestDTO.status}
                              AND rev.REV_ID = (
                                  SELECT MAX(REV_ID) 
                                  FROM BNK.FUND_MASTER_REVISION 
                                  WHERE FUND_CODE = fm.fund_code
                              )
                        )
                    </when>
                    <!-- 나머지는 oper_status로 검색 -->
                    <otherwise>
                        AND fm.oper_status = #{pageRequestDTO.status}
                    </otherwise>
                </choose>
            </if>
            AND fm.oper_status != '대기'

        </where>
    </sql>


    <!-- 상품 목록 페이지 조회 -->
    <select id="selectProductList"
            parameterType="kr.co.bnk.bnk_project.dto.PageRequestDTO"
            resultType="kr.co.bnk.bnk_project.dto.admin.ProductListDTO">

        SELECT
        fm.fund_code           AS fundCode,
        fm.fund_type           AS fundType,
        fc.category_name       AS categoryName, <!-- 한글 유형-->
        fm.fund_name           AS fundName,
        amc.operator_name      AS operatorName,
        fm.reg_date            AS regDate,
        fm.oper_status         AS operStatus,
        fm.last_upd_date       AS lastUpdDate,
        NVL(rev.REV_STATUS, '') AS revStatus,
        NVL(rev.REV_STATUS, '') AS updateStat,
        fm.OPER_START_AT       AS operStartAt
        FROM fund_master fm
        JOIN asset_management_company amc
        ON fm.asset_manager_id = amc.operator_id
        JOIN fund_category fc
        ON fm.fund_type = fc.category_code
        LEFT JOIN (
            SELECT FUND_CODE, REV_STATUS, ROW_NUMBER() OVER (PARTITION BY FUND_CODE ORDER BY CREATED_AT DESC) AS rn
            FROM BNK.FUND_MASTER_REVISION
            WHERE REV_STATUS IN ('대기', '승인완료', '수정완료', '수정반려')
        ) rev ON fm.fund_code = rev.fund_code AND rev.rn = 1

        <include refid="productWhere"/>
        ORDER BY fm.reg_date DESC
        OFFSET #{pageRequestDTO.offset} ROWS
        FETCH NEXT #{pageRequestDTO.size} ROWS ONLY

    </select>

    <select id="selectProductTotal"
            parameterType="kr.co.bnk.bnk_project.dto.PageRequestDTO"
            resultType="int">
        SELECT COUNT(*)
        FROM fund_master fm
        <include refid="productWhere"/>

    </select>

    <update id="updateOperStatus">
        UPDATE BNK.FUND_MASTER
        SET
            OPER_STATUS   = '등록대기'
        WHERE FUND_CODE = #{fundCode}
    </update>


    <update id="updateStatus">
        UPDATE BNK.FUND_MASTER
        SET LAST_UPD_DATE = SYSDATE
        WHERE FUND_CODE = #{fundCode}
    </update>

    <update id="updateStatusAfterApproval">
        UPDATE BNK.FUND_MASTER
        SET
            OPER_STATUS = CASE
                              WHEN OPER_STATUS='등록대기'
                                  THEN (CASE WHEN #{status} = '승인' THEN '등록완료' ELSE '등록반려' END)
                              ELSE OPER_STATUS
                          END,
            LAST_UPD_DATE = SYSDATE
        WHERE FUND_CODE = #{fundCode}
    </update>

    <!-- AdminFundMapper.xml -->

    <select id="selectFundsForOperateReserve"
            resultType="kr.co.bnk.bnk_project.dto.admin.AdminFundMasterDTO">
        SELECT FUND_CODE,
        FUND_NAME,
        OPER_STATUS,
        RESERVE_YN,
        OPER_START_AT
        FROM BNK.FUND_MASTER
        WHERE OPER_STATUS = '운용대기'
        AND RESERVE_YN = 'Y'
        AND OPER_START_AT IS NOT NULL
        AND OPER_START_AT &lt;= SYSDATE
    </select>

    <!-- 운용 상태를 '운용중'으로 업데이트 -->
    <update id="updateOperStatusToRunning">
        UPDATE BNK.FUND_MASTER
        SET OPER_STATUS   = '운용중',
            RESERVE_YN    = 'N',
            OPER_START_AT = NULL
        WHERE FUND_CODE = #{fundCode}
    </update>

    <!-- 상태를 운용대기로 변경 (등록완료일 때만) -->
    <update id="updateStatusToPending">
        UPDATE BNK.FUND_MASTER
        SET OPER_STATUS = '운용대기',
            LAST_UPD_DATE = SYSDATE
        WHERE FUND_CODE = #{fundCode}
          AND OPER_STATUS = '등록완료'
    </update>

    <!-- 예약시간 설정 (등록완료 → 운용대기 예약용) -->
    <update id="setFundReserveTime">
        UPDATE BNK.FUND_MASTER
        SET OPER_START_AT = #{operStartAt},
            RESERVE_YN    = 'Y'
        WHERE FUND_CODE = #{fundCode}
    </update>

    <!-- 예약 시간이 지난 모든 펀드 조회 (revision 적용 배치용) -->
    <select id="selectFundsWithExpiredReserveTime"
            resultType="kr.co.bnk.bnk_project.dto.admin.AdminFundMasterDTO">
        SELECT FUND_CODE AS fundCode,
               FUND_NAME AS fundName,
               OPER_STATUS AS operStatus,
               RESERVE_YN AS reserveYn,
               OPER_START_AT AS operStartAt
        FROM BNK.FUND_MASTER
        WHERE OPER_START_AT IS NOT NULL
          AND OPER_START_AT &lt;= SYSDATE
          AND RESERVE_YN = 'Y'
    </select>

    <!-- 예약 시간 초기화 (revision 적용 후) -->
    <update id="clearReserveTime">
        UPDATE BNK.FUND_MASTER
        SET RESERVE_YN    = 'N',
            OPER_START_AT = NULL
        WHERE FUND_CODE = #{fundCode}
    </update>

</mapper>

<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>은행 펀드 상품 관리자</title>
    <link rel="stylesheet" th:href="@{/css/admin/admin_styles.css}">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
    <!-- 사이드바 Fragment -->
    <div th:replace="~{admin/_sidebar :: sidebar(null)}"></div>

    <div class="main-content">
        <!-- 헤더 Fragment -->
        <div th:replace="~{admin/_header :: header}"></div>
        <div class="main-content-body">
            <div class="container">
        
        <!-- 통계 카드 섹션 -->
        <section class="stats-section">
            <div class="stat-card">
                <div class="stat-content">
                    <h3>총 가입자수</h3>
                    <p class="stat-value" id="totalUsers">0</p>
                    <span class="stat-label">명</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-content">
                    <h3>신규 가입자수</h3>
                    <p class="stat-value" id="newUsers">0</p>
                    <span class="stat-label">명</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-content">
                    <h3>해지건수</h3>
                    <p class="stat-value" id="cancellations">0</p>
                    <span class="stat-label">건</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-content">
                    <h3>총 운용 금액</h3>
                    <p class="stat-value" id="totalAmount">0</p>
                    <span class="stat-label">원</span>
                </div>
            </div>
        </section>

        <!-- 차트 섹션 -->
        <section class="charts-section">
            <!-- 투자 성향 원형 차트 -->
            <div class="chart-card">
                <h2>가입자 투자 성향 분포</h2>
                <div class="chart-container pie-chart">
                    <div id="investmentTendencyChart" style="width: 100%; height: 400px;"></div>
                </div>
            </div>

            <!-- 판매 금액 추이 막대 그래프 -->
            <div class="chart-card">
                <div class="chart-header">
                    <h2>판매 금액 추이</h2>
                    <div class="chart-controls">
                        <div class="period-selector">
                            <button class="period-btn active" data-period="daily">일별</button>
                            <button class="period-btn" data-period="monthly">월별</button>
                        </div>
                        <div class="week-selector" id="weekSelector" style="display: none;">
                            <label for="weekSelect">주 선택: </label>
                            <select id="weekSelect" class="week-select">
                                <!-- 주 옵션이 동적으로 추가됩니다 -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <div id="salesChart" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
        </section>

        <!-- Top5 펀드 테이블 -->
        <section class="table-section">
            <div class="table-card">
                <h2>가입수가 많은 펀드 Top 5</h2>
                <table class="fund-table">
                    <thead>
                        <tr>
                            <th>순위</th>
                            <th>펀드명</th>
                            <th>운용사</th>
                            <th>가입자수</th>
                            <th>판매금액</th>
                        </tr>
                    </thead>
                    <tbody id="topFundsTableBody">
                        <tr>
                            <td>1</td>
                            <td>BNK 성장형 펀드</td>
                            <td>BNK부산은행</td>
                            <td>12,450</td>
                            <td>245,000,000,000</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>KB 안정형 펀드</td>
                            <td>KB은행</td>
                            <td>11,230</td>
                            <td>218,000,000,000</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>신한 밸런스 펀드</td>
                            <td>신한은행</td>
                            <td>10,890</td>
                            <td>198,000,000,000</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>하나 글로벌 펀드</td>
                            <td>하나은행</td>
                            <td>9,560</td>
                            <td>175,000,000,000</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>우리 배당형 펀드</td>
                            <td>우리은행</td>
                            <td>8,920</td>
                            <td>162,000,000,000</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        </div>
    </div>
    </div>

    <script>
        // DOM이 모두 로드된 후 실행
        document.addEventListener('DOMContentLoaded', function() {
            // ECharts 로드 확인
            if (typeof echarts === 'undefined') {
                console.error('ECharts가 로드되지 않았습니다. 스크립트를 확인해주세요.');
                return;
            }

            function initCharts() {
                /* ==========================
                   1. 통계 카드 숫자 세팅
                   ========================== */
                document.getElementById('totalUsers').textContent = '125,847';
                document.getElementById('newUsers').textContent = '2,345';
                document.getElementById('cancellations').textContent = '156';
                document.getElementById('totalAmount').textContent = '1,234,567,890,000';

                /* ==========================
                   2. 투자 성향 원형 차트
                   ========================== */
                const investmentChartDom = document.getElementById('investmentTendencyChart');
                if (!investmentChartDom) {
                    console.error('investmentTendencyChart 요소를 찾을 수 없습니다.');
                    return;
                }

                const investmentChart = echarts.init(investmentChartDom);

                const investmentData = [35, 25, 28, 8, 4];
                const investmentLabels = ['주식형', '채권형', '혼합형', 'MMF', '기타'];
                const total = investmentData.reduce((a, b) => a + b, 0);
                const maxIndex = investmentData.indexOf(Math.max(...investmentData));
                const maxPercentage = ((investmentData[maxIndex] / total) * 100).toFixed(1);
                const maxLabel = investmentLabels[maxIndex];

                const investmentOption = {
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            const percentage = ((params.value / total) * 100).toFixed(1);
                            return params.name + ': ' + percentage + '%';
                        }
                    },
                    legend: {
                        orient: 'horizontal',
                        bottom: 10,
                        itemGap: 20,
                        textStyle: {
                            fontSize: 12
                        }
                    },
                    series: [
                        {
                            name: '투자 성향',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            center: ['50%', '45%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 5,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: 20,
                                    fontWeight: 'bold'
                                }
                            },
                            labelLine: {
                                show: false
                            },
                            data: investmentLabels.map((label, index) => ({
                                value: investmentData[index],
                                name: label
                            })),
                            color: ['#cd1317', '#ff6b6b', '#ffa500', '#4ecdc4', '#95e1d3'] 
                        }
                    ],
                };

                investmentChart.setOption(investmentOption);

                /* ==========================
                   3. 판매 금액 막대 차트
                   ========================== */
                const salesChartDom = document.getElementById('salesChart');
                if (!salesChartDom) {
                    console.error('salesChart 요소를 찾을 수 없습니다.');
                    return;
                }
                const salesChart = echarts.init(salesChartDom);

                // 일별 데이터
                const dailyData = {
                    labels: ['월', '화', '수', '목', '금', '토', '일'],
                    data: [125000000, 158000000, 142000000, 168000000, 195000000, 98000000, 75000000]
                };

                // 월별 데이터
                const monthlyData = {
                    labels: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
                    data: [3450000000, 3820000000, 4150000000, 3980000000, 4520000000, 4780000000, 4910000000, 5230000000, 4870000000, 5120000000, 5380000000, 5620000000]
                };

                // 막대 차트 옵션 생성 함수
                function createSalesChart(dataset, isDaily = true) {
                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            },
                            formatter: function(params) {
                                const value = params[0].value;
                                return params[0].name + '<br/>판매금액: ' + value.toLocaleString() + '원';
                            }
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            data: dataset.labels,
                            axisTick: {
                                alignWithLabel: true
                            }
                        },
                        yAxis: {
                            type: 'value',
                            axisLabel: {
                                formatter: function(value) {
                                    return (value / 1000000).toFixed(0) + 'M';
                                }
                            }
                        },
                        series: [
                            {
                                name: '판매금액',
                                type: 'bar',
                                barWidth: isDaily ? '30%' : '60%',
                                data: dataset.data,
                                itemStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        { offset: 0, color: '#d3d3d3' },  // 밝은 회색
                                        { offset: 1, color: '#808080' }    // 어두운 회색
                                    ])
                                },
                                label: {
                                    show: true,
                                    position: 'top',
                                    formatter: function(params) {
                                        return (params.value / 1000000).toFixed(0) + 'M';
                                    },
                                    fontSize: 11
                                }
                            }
                        ]
                    };

                    salesChart.setOption(option);
                }

                // 초기 차트 생성 (일별)
                createSalesChart(dailyData, true);

                // 일별/월별 버튼 클릭 이벤트
                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document
                            .querySelectorAll('.period-btn')
                            .forEach(b => b.classList.remove('active'));
                        this.classList.add('active');

                        const period = this.dataset.period;
                        if (period === 'daily') {
                            document.getElementById('weekSelector').style.display = 'none';
                            createSalesChart(dailyData, true);
                        } else {
                            document.getElementById('weekSelector').style.display = 'none';
                            createSalesChart(monthlyData, false);
                        }
                    });
                });

                // 창 크기 변경 시 반응형 처리
                window.addEventListener('resize', function() {
                    investmentChart.resize();
                    salesChart.resize();
                });
            }

            // 차트 초기화 실행
            initCharts();
        });
    </script>
    <!-- 사이드바 스크립트 -->
    <div th:replace="~{admin/_sidebar :: sidebar-script}"></div>
</body>
</html>


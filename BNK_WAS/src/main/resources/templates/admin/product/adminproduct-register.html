<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>펀드 등록 - 은행 펀드 상품 관리자</title>
    <link rel="stylesheet" th:href="@{/css/admin/admin_styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin/adminproduct.css}">
</head>
<body>
<!-- 사이드바 Fragment -->
<div th:replace="~{admin/_sidebar :: sidebar('product-register')}"></div>

<div class="main-content">
    <!-- 헤더 Fragment -->
    <div th:replace="~{admin/_header :: header}"></div>
    <div class="main-content-body">
        <div class="container">
            <!-- 페이지 헤더 -->
            <header class="page-header">
                <h1>펀드 신규 등록</h1>
            </header>

            <!-- 펀드 검색 (GET) -->
            <form th:action="@{/admin/product/register}" method="get" class="product-classification-bar">
                <div class="classification-label">펀드 검색</div>
                <div class="classification-inputs">
                    <select class="form-select search-select-small"
                            id="searchType"
                            name="searchType"
                            th:value="${pageRequestDTO != null} ? ${pageRequestDTO.searchType} : 'code'">
                                <option value="name"
                                        th:selected="${pageRequestDTO != null and pageRequestDTO.searchType == 'name'}">펀드명
                                </option>
                                <option value="code"
                                        th:selected="${pageRequestDTO != null and pageRequestDTO.searchType == 'code'}">펀드코드
                                </option>

                    </select>

                    <div class="search-input-wrapper-inline" style="position: relative; width: 100%;">
                        <input type="text"
                               class="form-input search-input-large"
                               id="searchKeyword"
                               name="keyword"
                               placeholder="입력하세요"
                               autocomplete="off"
                               th:value="${pageRequestDTO != null} ? ${pageRequestDTO.keyword} : ''"
                               style="padding-right: 90px;">

                        <button class="btn btn-search-inline" type="submit"
                                style="position: absolute; right: 0; top: 50%; transform: translateY(-50%);">
                            검색
                        </button>

                        <!-- 자동완성 리스트 박스 -->
                        <div id="searchSuggestions"
                             style="position:absolute; top:calc(100% + 4px); left:0; right:0; background:#fff; border:1px solid #ddd; border-top:none; z-index:1000; display:none; max-height:200px; overflow-y:auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        </div>
                    </div>
                </div>
            </form>
            
            <!-- 에러 메시지 표시 (.product-classification-bar 밑) -->
            <div th:if="${errorMessage != null}" 
                 style="margin-bottom: 10px; padding: 10px; background-color: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33;">
                <span th:text="${errorMessage}">이미 등록된 펀드입니다.</span>
            </div>

            <!-- 펀드 등록/수정 (POST) -->
            <form id="registerForm" th:action="@{/admin/product/register}" method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- 필수정보 -->
                <div class="form-section">
                    <h2 class="section-title">필수정보</h2>
                    <div class="form-table">

                        <!-- 상품명  -->
                        <div class="form-row">
                            <div class="form-label">상품명</div>
                            <div class="form-input-wrapper">
                                <input type="text" class="form-input"
                                       id="productName"
                                       name="fundName"
                                       placeholder="상품명을 입력하세요"
                                       th:value="${fund != null} ? ${fund.fundName} : ''"
                                       readonly>
                            </div>
                        </div>

                        <!-- 상품코드 -->
                        <div class="form-row">
                            <div class="form-label">상품코드</div>
                            <div class="form-input-wrapper">
                                <input type="text" class="form-input"
                                       id="productCode"
                                       name="fundCode"
                                       placeholder="상품코드를 입력하세요"
                                       th:value="${fund != null} ? ${fund.fundCode} : ''"
                                       readonly>
                            </div>
                        </div>

                        <!-- 펀드유형  -->
                        <div class="form-row">
                            <div class="form-label">펀드유형</div>
                            <div class="form-input-wrapper">
                                <select class="form-select"
                                        name="fundType"
                                        required>
                                    <option value="">펀드유형 선택</option>
                                    <option th:each="cat : ${categoryList}"
                                            th:value="${cat.categoryCode}"
                                            th:text="${cat.categoryName}"
                                            th:selected="${fund != null and fund.fundType == cat.categoryCode}">
                                    </option>
                                </select>
                            </div>
                        </div>

                        <!-- 투자등급  -->
                        <div class="form-row">
                            <div class="form-label">투자등급</div>
                            <div class="form-input-wrapper">
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="investGrade" value="매우 낮은 위험"
                                               th:checked="${fund != null and fund.investGrade == '매우 낮은 위험'}"> 매우 낮은 위험
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="investGrade" value="낮은 위험"
                                               th:checked="${fund != null and fund.investGrade == '낮은 위험'}"> 낮은 위험
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="investGrade" value="중간 위험"
                                               th:checked="${fund != null and fund.investGrade == '중간 위험'}"> 중간 위험
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="investGrade" value="다소 높은 위험"
                                               th:checked="${fund != null and fund.investGrade == '다소 높은 위험'}"> 다소 높은 위험
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="investGrade" value="높은 위험"
                                               th:checked="${fund != null and fund.investGrade == '높은 위험'}"> 높은 위험
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="investGrade" value="매우 높은 위험"
                                               th:checked="${fund != null and fund.investGrade == '매우 높은 위험'}"> 매우 높은 위험
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 가입경로  -->
                        <div class="form-row">
                            <div class="form-label">가입경로</div>
                            <div class="form-input-wrapper">
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="subscriptionMethod" value="인터넷, 스마트폰"
                                               th:checked="${fund != null and (fund.subscriptionMethod == '인터넷, 스마트폰' or fund.subscriptionMethod == '인터넷, 스마트폰')}"
                                               required> 인터넷, 스마트폰
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="subscriptionMethod" value="오프라인"
                                               th:checked="${fund != null and fund.subscriptionMethod == '오프라인'}"
                                               required> 오프라인
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-label">운용사</div>
                            <div class="form-input-wrapper">
                                <input type="text"
                                       class="form-input"
                                       id="managementCompany"
                                       placeholder="운용사를 입력하세요"
                                       th:value="${fund != null} ? ${fund.assetManagerName} : ''"
                                       readonly>
                            </div>
                        </div>


                        <!-- 상품특징  -->
                        <div class="form-row">
                            <div class="form-label">상품특징</div>
                            <div class="form-input-wrapper">
                                    <textarea class="form-textarea"
                                              id="productFeatures"
                                              name="fundFeature"
                                              rows="5"
                                              placeholder="상품특징을 입력하세요"
                                              th:text="${fund != null} ? ${fund.fundFeature} : ''"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 유의사항 -->
                <div class="form-section">
                    <h2 class="section-title">유의사항</h2>
                    <div class="form-table">
                        <div class="form-row">
                            <div class="form-label">상품별 주요 투자 위험</div>
                            <div class="form-input-wrapper">
                                <textarea class="form-textarea" 
                                          id="precautions1" 
                                          name="notice1"
                                          rows="5" 
                                          placeholder="유의사항을 입력하세요"
                                          th:text="${fund != null} ? ${fund.notice1} : ''"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-label">이익 및 손실 발행 구조</div>
                            <div class="form-input-wrapper">
                                <textarea class="form-textarea" 
                                          id="precautions2" 
                                          name="notice2"
                                          rows="5" 
                                          placeholder="유의사항을 입력하세요"
                                          th:text="${fund != null} ? ${fund.notice2} : ''"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 문서관리 -->
                <div class="form-section">
                    <h2 class="section-title">문서관리</h2>
                    <div class="form-table">
                        <div class="form-row">
                            <div class="form-label">약관</div>
                            <div class="form-input-wrapper">
                                <div class="file-upload" id="termsDocUpload">
                                    <input type="file" id="termsDoc" name="termsDoc" accept=".pdf,.doc,.docx" style="display: none;">
                                    <button type="button" class="btn btn-secondary" id="termsDocButton" onclick="document.getElementById('termsDoc').click()">파일 선택</button>
                                </div>
                                <div id="termsDocList" class="file-list"></div>
                                <small class="file-help">PDF, DOC, DOCX 파일만 업로드 가능합니다.</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-label">투자설명서</div>
                            <div class="form-input-wrapper">
                                <div class="file-upload" id="investmentDocUpload">
                                    <input type="file" id="investmentDoc" name="investmentDoc" accept=".pdf,.doc,.docx" style="display: none;">
                                    <button type="button" class="btn btn-secondary" id="investmentDocButton" onclick="document.getElementById('investmentDoc').click()">파일 선택</button>
                                </div>
                                <div id="investmentDocList" class="file-list"></div>
                                <small class="file-help">PDF, DOC, DOCX 파일만 업로드 가능합니다.</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-label">간이 투자 설명서</div>
                            <div class="form-input-wrapper">
                                <div class="file-upload" id="simpleInvestmentDocUpload">
                                    <input type="file" id="simpleInvestmentDoc" name="simpleInvestmentDoc" accept=".pdf,.doc,.docx" style="display: none;">
                                    <button type="button" class="btn btn-secondary" id="simpleInvestmentDocButton" onclick="document.getElementById('simpleInvestmentDoc').click()">파일 선택</button>
                                </div>
                                <div id="simpleInvestmentDocList" class="file-list"></div>
                                <small class="file-help">PDF, DOC, DOCX 파일만 업로드 가능합니다.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 폼 액션 버튼 -->
                <div class="form-actions">
                    <!-- ★ 실제 submit 되도록 type="submit" -->
                    <button type="submit" class="btn btn-red">등록</button>
                    <a th:href="@{/admin/product}" class="btn btn-secondary">취소</a>
                </div>

                <!-- 푸터 영역 -->
                <footer class="admin-footer"></footer>
            </form>
        </div>
    </div>
</div>

<!-- 사이드바 스크립트 -->
<div th:replace="~{admin/_sidebar :: sidebar-script}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {

        // ==========================
        // 0. 등록 폼 제출 전 중복 확인
        // ==========================
        const registerForm = document.getElementById('registerForm');
        if (registerForm) {
            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault(); // 기본 제출 동작 막기

                const fundCode = document.getElementById('productCode')?.value || '';
                const fundName = document.getElementById('productName')?.value || '';

                // 펀드코드나 펀드명이 없으면 그냥 제출
                if (!fundCode && !fundName) {
                    registerForm.submit();
                    return;
                }

                // 중복 확인 API 호출
                try {
                    const csrfToken = document.querySelector('input[name="_csrf"]')?.value || '';
                    
                    const formData = new FormData();
                    if (fundCode) formData.append('fundCode', fundCode);
                    if (fundName) formData.append('fundName', fundName);
                    formData.append('_csrf', csrfToken);

                    const checkUrl = /*[[@{/admin/product/check-duplicate}]]*/ '';
                    console.log('중복 확인 API 호출:', checkUrl, {fundCode, fundName});

                    const response = await fetch(checkUrl, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        console.error('서버 응답 오류:', response.status, response.statusText);
                        throw new Error('서버 응답 오류: ' + response.status);
                    }

                    const result = await response.json();
                    console.log('중복 확인 결과:', result);

                    if (result.duplicate === true) {
                        // 이미 등록된 펀드면 팝업 표시하고 제출 중단 (페이지에 그대로 머물러 있음)
                        alert('이미 등록된 펀드입니다.');
                        return false; // 폼 제출 중단
                    } else {
                        // 중복이 아니면 폼 제출 (등록 후 같은 페이지로 리다이렉트됨)
                        registerForm.submit();
                    }
                } catch (error) {
                    console.error('중복 확인 중 오류 발생:', error);
                    // 오류 발생 시에도 제출 (서버 측에서 다시 확인)
                    registerForm.submit();
                }
            });
        }

        // ==========================
        // 0-1. 성공/에러 메시지 팝업 표시
        // ==========================
        const successMessage = /*[[${successMessage}]]*/ null;
        if (successMessage) {
            alert(successMessage);
        }

        const errorMessage = /*[[${errorMessage}]]*/ null;
        const showPopup = /*[[${showPopup}]]*/ false;
        if (errorMessage && showPopup) {
            alert(errorMessage);
        }

        // ==========================
        // 1. 펀드 자동완성 (코드/이름 모두 지원)
        // ==========================
        const searchTypeSelect = document.getElementById('searchType');
        const searchInput = document.getElementById('searchKeyword');
        const suggestionBox = document.getElementById('searchSuggestions');

        if (searchTypeSelect && searchInput && suggestionBox) {
            let suggestionTimer = null;
            let activeIndex = -1;

            function clearSuggestions() {
                suggestionBox.style.display = 'none';
                suggestionBox.innerHTML = '';
                activeIndex = -1;
            }

            function applyActiveState(items) {
                items.forEach((item, idx) => {
                    if (idx === activeIndex) {
                        item.style.backgroundColor = '#f0f4ff';
                        item.style.fontWeight = '600';
                    } else {
                        item.style.backgroundColor = '#ffffff';
                        item.style.fontWeight = 'normal';
                    }
                });
            }

            function selectSuggestion(item) {
                const fundCode = item.getAttribute('data-fund-code');
                const fundName = item.getAttribute('data-fund-name');
                const currentType = searchTypeSelect.value; // 'code' or 'name'

                if (currentType === 'code') {
                    searchInput.value = fundCode;
                } else {
                    searchInput.value = fundName;
                }

                clearSuggestions();
                searchInput.form.submit();
            }

            const autocompleteUrl = /*[[@{/admin/product/autocomplete}]]*/ '';

            searchInput.addEventListener('input', function() {
                const keyword = this.value.trim();
                const searchType = searchTypeSelect.value;

                if (keyword.length < 1) {
                    clearSuggestions();
                    return;
                }

                if (suggestionTimer) {
                    clearTimeout(suggestionTimer);
                }

                suggestionTimer = setTimeout(() => {
                    fetch(`${autocompleteUrl}?searchType=${encodeURIComponent(searchType)}&keyword=${encodeURIComponent(keyword)}`)
                        .then(res => {
                            if (!res.ok) {
                                throw new Error('API 호출 실패');
                            }
                            return res.json();
                        })
                        .then(data => {
                            if (!data || data.length === 0) {
                                clearSuggestions();
                                return;
                            }

                            suggestionBox.innerHTML = '';

                            data.forEach((item, idx) => {
                                const div = document.createElement('div');
                                div.className = 'suggestion-item';
                                div.style.padding = '10px 12px';
                                div.style.cursor = 'pointer';
                                div.style.fontSize = '14px';
                                div.style.borderBottom = '1px solid #eee';
                                div.style.transition = 'background-color 0.2s';

                                div.textContent = `${item.fundCode} - ${item.fundName}`;

                                div.setAttribute('data-fund-code', item.fundCode);
                                div.setAttribute('data-fund-name', item.fundName);

                                div.addEventListener('mouseenter', () => {
                                    activeIndex = idx;
                                    applyActiveState([...suggestionBox.children]);
                                });

                                div.addEventListener('mouseleave', () => {
                                    activeIndex = -1;
                                    applyActiveState([...suggestionBox.children]);
                                });

                                div.addEventListener('click', () => {
                                    selectSuggestion(div);
                                });

                                suggestionBox.appendChild(div);
                            });

                            suggestionBox.style.display = 'block';
                            activeIndex = -1;
                        })
                        .catch(err => {
                            console.error('자동완성 에러:', err);
                            clearSuggestions();
                        });
                }, 200);
            });

            searchInput.addEventListener('keydown', function(e) {
                const items = [...suggestionBox.children];

                if (items.length === 0 || suggestionBox.style.display === 'none') {
                    return;
                }

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    activeIndex = (activeIndex + 1) % items.length;
                    applyActiveState(items);
                    items[activeIndex].scrollIntoView({ block: 'nearest' });
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    activeIndex = (activeIndex - 1 + items.length) % items.length;
                    applyActiveState(items);
                    items[activeIndex].scrollIntoView({ block: 'nearest' });
                } else if (e.key === 'Enter') {
                    if (activeIndex >= 0 && activeIndex < items.length) {
                        e.preventDefault();
                        selectSuggestion(items[activeIndex]);
                    }
                } else if (e.key === 'Escape') {
                    clearSuggestions();
                }
            });

            document.addEventListener('click', function(e) {
                if (!suggestionBox.contains(e.target) &&
                    e.target !== searchInput &&
                    e.target !== searchTypeSelect) {
                    clearSuggestions();
                }
            });
        }

        // ==========================
        // 2. 파일 업로드 관련
        // ==========================
        const termsInput = document.getElementById('termsDoc');
        const investmentInput = document.getElementById('investmentDoc');
        const simpleInvestmentInput = document.getElementById('simpleInvestmentDoc');

        if (termsInput) {
            termsInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    addFileToList('termsDocList', file, 'termsDoc');
                    document.getElementById('termsDocUpload').style.display = 'none';
                }
            });
        }

        if (investmentInput) {
            investmentInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    addFileToList('investmentDocList', file, 'investmentDoc');
                    document.getElementById('investmentDocUpload').style.display = 'none';
                }
            });
        }

        if (simpleInvestmentInput) {
            simpleInvestmentInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    addFileToList('simpleInvestmentDocList', file, 'simpleInvestmentDoc');
                    document.getElementById('simpleInvestmentDocUpload').style.display = 'none';
                }
            });
        }

        function addFileToList(listId, file, inputId) {
            const fileList = document.getElementById(listId);
            if (!fileList) return;

            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                    <span class="file-item-name">${file.name}</span>
                    <div class="file-actions">
                        <a href="#" class="file-download" title="다운로드">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="download-icon">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                            </svg>
                        </a>
                        <button type="button" class="file-item-remove" onclick="removeFile(this, '${listId}', '${inputId}')" title="삭제">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="delete-icon">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                `;
            fileList.innerHTML = '';
            fileList.appendChild(fileItem);
        }

        window.removeFile = function(button, listId, inputId) {
            const fileList = document.getElementById(listId);
            if (fileList) {
                fileList.innerHTML = '';
            }

            const input = document.getElementById(inputId);
            if (input) {
                input.value = '';
            }

            if (inputId === 'termsDoc') {
                document.getElementById('termsDocUpload').style.display = 'flex';
            } else if (inputId === 'investmentDoc') {
                document.getElementById('investmentDocUpload').style.display = 'flex';
            } else if (inputId === 'simpleInvestmentDoc') {
                document.getElementById('simpleInvestmentDocUpload').style.display = 'flex';
            }
        };


    });
    /*]]>*/
</script>

</body>
</html>

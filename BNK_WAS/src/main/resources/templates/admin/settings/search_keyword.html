<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>검색어 관리 - 은행 펀드 상품 관리자</title>
    <link rel="stylesheet" th:href="@{/css/admin/admin_styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin/adminproduct.css}">
    <link rel="stylesheet" th:href="@{/css/admin/settings_styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin/info_disclosure.css}">
</head>
<body>
<!-- 사이드바 Fragment -->
<div th:replace="~{admin/_sidebar :: sidebar('settings-search-keyword')}"></div>

<div class="main-content">
    <!-- 헤더 Fragment -->
    <div th:replace="~{admin/_header :: header}"></div>

    <div class="main-content-body">
        <div class="container">
            <header class="page-header">
                <h1>검색어 관리</h1>
                <div class="header-actions">
                    <button type="button" id="openKeywordModal" class="btn btn-primary">등록</button>
                </div>
            </header>

            <section class="section-block">
                <div class="table-info">
                    <span>총 <strong th:text="${pageResponse != null ? pageResponse.total : 0}">0</strong>건</span>
                    <span class="pagination-info" th:if="${pageResponse != null}">
                        <span th:text="${pageResponse.pg}">1</span> / <span th:text="${pageResponse.end}">1</span> page
                    </span>
                </div>
                <table class="fund-table">
                    <thead>
                    <tr>
                        <th>번호</th>
                        <th>검색어</th>
                        <th>등록일</th>
                        <th>관리</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${pageResponse == null or #lists.isEmpty(pageResponse.dtoList)}">
                        <td colspan="4" class="text-center">검색어가 없습니다.</td>
                    </tr>
                    <tr th:each="dto, stat : ${pageResponse.dtoList}">
                        <td th:text="${pageResponse.startNo - stat.index}">1</td>
                        <td class="text-left" th:text="${dto.keywordName}">해외주식형</td>
                        <td th:text="${dto.regDate != null ? dto.regDate : ''}">2024-04-12</td>
                        <td class="cell-actions">
                            <button type="button" class="btn-action" 
                                    data-action="edit"
                                    th:attr="data-keyword-no=${dto.keywordNo},
                                             data-keyword-name=${dto.keywordName},
                                             data-related-words=${dto.relatedWords != null ? dto.relatedWords : ''}">수정</button>
                            <button type="button" class="btn-action" 
                                    data-action="delete"
                                    th:attr="data-keyword-no=${dto.keywordNo},
                                             data-keyword-name=${dto.keywordName}">삭제</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </section>
            <!-- 페이징 -->
            <div class="pagination" th:if="${pageResponse != null and pageResponse.total > 0}">
                <a class="page-btn prev"
                   th:href="@{/admin/settings/keyword(pg=${pageResponse.pg - 1})}"
                   th:classappend="${!pageResponse.prev} ? ' disabled'"
                   th:attr="aria-disabled=${!pageResponse.prev}">
                    &lt;
                </a>
                <div class="page-numbers">
                    <a class="page-number"
                       th:each="num : ${#numbers.sequence(pageResponse.start, pageResponse.end)}"
                       th:href="@{/admin/settings/keyword(pg=${num})}"
                       th:text="${num}"
                       th:classappend="${num == pageResponse.pg} ? ' active'">
                        1
                    </a>
                </div>
                <a class="page-btn next"
                   th:href="@{/admin/settings/keyword(pg=${pageResponse.pg + 1})}"
                   th:classappend="${!pageResponse.next} ? ' disabled'"
                   th:attr="aria-disabled=${!pageResponse.next}">
                    &gt;
                </a>
            </div>
            <!-- 푸터 영역 -->
            <footer class="admin-footer"></footer>
        </div>
    </div>
</div>

<!-- 등록 모달 -->
<div id="keywordModal" class="modal-overlay">
    <div class="modal-card">
        <h3>검색어 등록</h3>
        <form id="keywordForm" class="modal-form" th:action="@{/admin/settings/keyword/register}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <div class="form-field">
                <label for="keywordValue">검색어명</label>
                <input type="text" id="keywordValue" name="keywordName" placeholder="검색어명을 입력하세요" required>
            </div>
            <div class="form-field">
                <label>연관단어</label>
                <div id="relatedWordsContainer">
                    <div class="related-word-item">
                        <input type="text" class="related-word-input" placeholder="연관단어를 입력하세요">
                        <button type="button" class="btn-remove-word" style="display: none;">삭제</button>
                    </div>
                </div>
                <button type="button" id="addRelatedWordBtn" class="btn btn-secondary" style="margin-top: 8px;">추가</button>
                <input type="hidden" id="relatedWordsHidden" name="relatedWords">
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">확인</button>
                <button type="button" id="keywordModalClose" class="btn btn-secondary">닫기</button>
            </div>
        </form>
    </div>
</div>

<!-- 수정 모달 -->
<div id="keywordEditModal" class="modal-overlay">
    <div class="modal-card">
        <h3>검색어 수정</h3>
        <form id="keywordEditForm" class="modal-form" th:action="@{/admin/settings/keyword/update}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <input type="hidden" id="editKeywordNo" name="keywordNo">
            <div class="form-field">
                <label for="editKeywordValue">검색어</label>
                <input type="text" id="editKeywordValue" name="keywordName" placeholder="검색어를 입력하세요" required>
            </div>
            <div class="form-field">
                <label>연관단어</label>
                <div id="editRelatedWordsContainer">
                    <div class="related-word-item">
                        <input type="text" class="related-word-input" placeholder="연관단어를 입력하세요">
                        <button type="button" class="btn-remove-word" style="display: none;">삭제</button>
                    </div>
                </div>
                <button type="button" id="addEditRelatedWordBtn" class="btn btn-secondary" style="margin-top: 8px;">추가</button>
                <input type="hidden" id="editRelatedWordsHidden" name="relatedWords">
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">확인</button>
                <button type="button" id="keywordEditModalClose" class="btn btn-secondary">닫기</button>
            </div>
        </form>
    </div>
</div>

<!-- 삭제 확인 모달 -->
<div id="keywordDeleteModal" class="modal-overlay">
    <div class="modal-card">
        <h3>검색어 삭제</h3>
        <div class="modal-form">
            <div class="form-field">
                <p style="margin: 0; color: #495057; font-size: 1rem;">
                    정말로 <strong id="deleteKeywordValue" style="color: #cd1317;"></strong> 검색어를 삭제하시겠습니까?
                </p>
                <p style="margin: 10px 0 0 0; color: #868e96; font-size: 0.9rem;">
                    삭제된 데이터는 복구할 수 없습니다.
                </p>
            </div>
            <form id="keywordDeleteForm" th:action="@{/admin/settings/keyword/delete}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <input type="hidden" id="deleteKeywordNo" name="keywordNo">
                <div class="modal-actions">
                    <button type="submit" id="keywordDeleteConfirm" class="btn btn-primary">삭제</button>
                    <button type="button" id="keywordDeleteModalClose" class="btn btn-secondary">취소</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 등록 모달
        const form = document.getElementById('keywordForm');
        const modal = document.getElementById('keywordModal');
        const openBtn = document.getElementById('openKeywordModal');
        const closeBtn = document.getElementById('keywordModalClose');

        // 수정 모달
        const editModal = document.getElementById('keywordEditModal');
        const editForm = document.getElementById('keywordEditForm');
        const editCloseBtn = document.getElementById('keywordEditModalClose');

        // 삭제 모달
        const deleteModal = document.getElementById('keywordDeleteModal');
        const deleteCloseBtn = document.getElementById('keywordDeleteModalClose');
        const deleteConfirmBtn = document.getElementById('keywordDeleteConfirm');

        // 공통 모달 열기/닫기 함수
        function showModal(modalElement) {
            modalElement?.classList.add('show');
        }

        function closeModal(modalElement) {
            modalElement?.classList.remove('show');
        }

        // 연관단어 동적 추가/제거 함수
        function addRelatedWordInput(container, initialValue = '') {
            const item = document.createElement('div');
            item.className = 'related-word-item';
            item.style.display = 'flex';
            item.style.gap = '8px';
            item.style.marginBottom = '8px';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'related-word-input';
            input.placeholder = '연관단어를 입력하세요';
            input.value = initialValue;
            input.style.flex = '1';
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn-remove-word';
            removeBtn.textContent = '삭제';
            removeBtn.style.padding = '6px 12px';
            removeBtn.style.background = '#dc3545';
            removeBtn.style.color = 'white';
            removeBtn.style.border = 'none';
            removeBtn.style.borderRadius = '4px';
            removeBtn.style.cursor = 'pointer';
            
            removeBtn.addEventListener('click', function() {
                item.remove();
                updateRelatedWordsHidden(container);
                // 항목이 하나만 남으면 삭제 버튼 숨기기
                if (container.children.length === 1) {
                    container.querySelector('.btn-remove-word').style.display = 'none';
                }
            });
            
            item.appendChild(input);
            item.appendChild(removeBtn);
            container.appendChild(item);
            
            // 삭제 버튼 표시/숨김 처리
            if (container.children.length > 1) {
                container.querySelectorAll('.btn-remove-word').forEach(btn => {
                    btn.style.display = 'block';
                });
            } else {
                removeBtn.style.display = 'none';
            }
        }
        
        function updateRelatedWordsHidden(container) {
            const inputs = container.querySelectorAll('.related-word-input');
            const values = Array.from(inputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');
            
            // 쉼표로 구분된 문자열 생성
            const relatedWordsValue = values.join(',');
            
            const hiddenInput = container.closest('.form-field').querySelector('input[type="hidden"]');
            if (hiddenInput) {
                hiddenInput.value = relatedWordsValue;
                console.log('연관단어 저장값:', relatedWordsValue); // 디버깅용
            }
        }
        
        // 등록 모달 연관단어 추가 버튼
        const addRelatedWordBtn = document.getElementById('addRelatedWordBtn');
        const relatedWordsContainer = document.getElementById('relatedWordsContainer');
        
        addRelatedWordBtn?.addEventListener('click', function() {
            addRelatedWordInput(relatedWordsContainer);
        });
        
        // 등록 모달 연관단어 입력 필드 변경 시 hidden 필드 업데이트
        relatedWordsContainer?.addEventListener('input', function(e) {
            if (e.target.classList.contains('related-word-input')) {
                updateRelatedWordsHidden(relatedWordsContainer);
            }
        });
        
        // 등록 모달
        openBtn?.addEventListener('click', () => {
            form.reset();
            // 연관단어 컨테이너 초기화
            relatedWordsContainer.innerHTML = '';
            addRelatedWordInput(relatedWordsContainer);
            document.getElementById('relatedWordsHidden').value = '';
            showModal(modal);
        });
        closeBtn?.addEventListener('click', () => closeModal(modal));

        form?.addEventListener('submit', function (event) {
            // 연관단어 값 업데이트 (폼 제출 전 최종 업데이트)
            updateRelatedWordsHidden(relatedWordsContainer);
            
            // 최종 값 확인
            const finalValue = document.getElementById('relatedWordsHidden').value;
            console.log('최종 제출값:', finalValue); // 디버깅용
        });

        modal?.addEventListener('click', function (event) {
            if (event.target === modal) {
                closeModal(modal);
            }
        });

        // 수정 모달
        editCloseBtn?.addEventListener('click', () => closeModal(editModal));
        editModal?.addEventListener('click', function (event) {
            if (event.target === editModal) {
                closeModal(editModal);
            }
        });

        // 수정 모달 연관단어 추가 버튼
        const addEditRelatedWordBtn = document.getElementById('addEditRelatedWordBtn');
        const editRelatedWordsContainer = document.getElementById('editRelatedWordsContainer');
        
        addEditRelatedWordBtn?.addEventListener('click', function() {
            addRelatedWordInput(editRelatedWordsContainer);
        });
        
        // 수정 모달 연관단어 입력 필드 변경 시 hidden 필드 업데이트
        editRelatedWordsContainer?.addEventListener('input', function(e) {
            if (e.target.classList.contains('related-word-input')) {
                updateRelatedWordsHidden(editRelatedWordsContainer);
            }
        });
        
        editForm?.addEventListener('submit', function (event) {
            // 연관단어 값 업데이트 (폼 제출 전 최종 업데이트)
            updateRelatedWordsHidden(editRelatedWordsContainer);
            
            // 최종 값 확인
            const finalValue = document.getElementById('editRelatedWordsHidden').value;
            console.log('수정 최종 제출값:', finalValue); // 디버깅용
        });

        // 삭제 모달
        deleteCloseBtn?.addEventListener('click', () => closeModal(deleteModal));

        deleteModal?.addEventListener('click', function (event) {
            if (event.target === deleteModal) {
                closeModal(deleteModal);
            }
        });

        // 테이블 행의 버튼 이벤트 처리
        document.querySelectorAll('[data-action]').forEach(button => {
            button.addEventListener('click', function () {
                const action = this.getAttribute('data-action');
                const keywordNo = this.getAttribute('data-keyword-no');
                const keywordName = this.getAttribute('data-keyword-name');
                const relatedWords = this.getAttribute('data-related-words') || '';

                if (action === 'edit') {
                    // 수정 모달에 데이터 채우기
                    document.getElementById('editKeywordNo').value = keywordNo || '';
                    document.getElementById('editKeywordValue').value = keywordName || '';
                    
                    // 연관단어 데이터 로드
                    editRelatedWordsContainer.innerHTML = '';
                    if (relatedWords) {
                        const words = relatedWords.split(',').filter(w => w.trim() !== '');
                        if (words.length > 0) {
                            words.forEach(word => {
                                addRelatedWordInput(editRelatedWordsContainer, word.trim());
                            });
                        } else {
                            addRelatedWordInput(editRelatedWordsContainer);
                        }
                    } else {
                        addRelatedWordInput(editRelatedWordsContainer);
                    }
                    document.getElementById('editRelatedWordsHidden').value = relatedWords;
                    
                    showModal(editModal);
                } else if (action === 'delete') {
                    // 삭제 모달에 데이터 채우기
                    document.getElementById('deleteKeywordValue').textContent = keywordName || '';
                    document.getElementById('deleteKeywordNo').value = keywordNo || '';
                    showModal(deleteModal);
                }
            });
        });
    });
</script>
<!-- 사이드바 스크립트 -->
<div th:replace="~{admin/_sidebar :: sidebar-script}"></div>
</body>
</html>
